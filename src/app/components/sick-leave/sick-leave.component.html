<div class="sick-leave-container">
  <h2>Sick Leave Certificate</h2>

  <form [formGroup]="sickLeaveForm" (ngSubmit)="onSubmit()" class="sick-leave-form">
    <div class="employee-info">
      <h3>Employee Information</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="employeeId">Employee ID:</label>
          <input type="text" id="employeeId" formControlName="employeeId" class="form-control" readonly>
          <div class="error-message"
            *ngIf="sickLeaveForm.get('employeeId')?.invalid && sickLeaveForm.get('employeeId')?.touched">
            Valid Employee ID is required
          </div>
        </div>
    
        <div class="form-group">
          <label for="employeeName">Employee Name:</label>
          <input type="text" id="employeeName" formControlName="employeeName" class="form-control" readonly>
          <div class="error-message"
            *ngIf="sickLeaveForm.get('employeeName')?.invalid && sickLeaveForm.get('employeeName')?.touched">
            Employee name is required
          </div>
        </div>
      </div>
    
      <div class="form-row">
        <div class="form-group">
          <label for="address">Address:</label>
          <input type="text" id="address" formControlName="address" class="form-control" readonly>
          <div class="error-message"
            *ngIf="sickLeaveForm.get('address')?.invalid && sickLeaveForm.get('address')?.touched">
            Address is required
          </div>
        </div>
    
        <div class="form-group">
          <label for="age">Age:</label>
          <input type="number" id="age" formControlName="age" class="form-control" readonly>
        </div>
    
        <div class="form-group">
          <label for="sex">Sex:</label>
          <input type="text" id="sex" formControlName="sex" class="form-control" readonly>
        </div>
      </div>
    </div>

    <div class="medical-info">
      <h3>Medical Information</h3>
      <div class="form-group">
        <label for="diagnosis">Diagnosis:</label>
        <textarea id="diagnosis" formControlName="diagnosis" class="form-control" rows="3" readonly></textarea>
        <div class="error-message"
          *ngIf="sickLeaveForm.get('diagnosis')?.invalid && sickLeaveForm.get('diagnosis')?.touched">
          Diagnosis is required
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="startDate">Start Date:</label>
          <input type="date" id="startDate" formControlName="startDate" class="form-control">
          <div class="error-message"
            *ngIf="sickLeaveForm.get('startDate')?.invalid && sickLeaveForm.get('startDate')?.touched">
            Start date is required
          </div>
        </div>

        <div class="form-group">
          <label for="endDate">End Date:</label>
          <input type="date" id="endDate" formControlName="endDate" class="form-control">
          <div class="error-message"
            *ngIf="sickLeaveForm.get('endDate')?.invalid && sickLeaveForm.get('endDate')?.touched">
            End date is required
          </div>
        </div>

        <div class="form-group">
          <label for="totalDays">Total Days:</label>
          <input type="number" id="totalDays" formControlName="totalDays" class="form-control" readonly>
        </div>
      </div>

      <div class="form-group">
        <label for="recommendations">Recommendations:</label>
        <textarea id="recommendations" formControlName="recommendations" class="form-control" rows="3"
          placeholder="Enter medical recommendations (optional)"></textarea>
      </div>

      <div class="form-group">
        <label for="examinedOn">Examined On:</label>
        <input type="date" id="examinedOn" formControlName="examinedOn" class="form-control" readonly>
      </div>
    </div>

    <div class="doctor-info">
      <h3>Doctor Information</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="doctorName">Doctor Name:</label>
          <input type="text" id="doctorName" formControlName="doctorName" class="form-control" readonly>
          <div class="error-message"
            *ngIf="sickLeaveForm.get('doctorName')?.invalid && sickLeaveForm.get('doctorName')?.touched">
            Doctor name is required
          </div>
        </div>
        
        <div class="form-group">
          <label for="signature">Signature:</label>
          <ng-container *ngIf="sickLeaveForm.get('SignatureText')?.value">
            <img [src]="getSignatureImageSrc()" 
                 class="signature-image" 
                 alt="Doctor's Signature"
                 (error)="handleSignatureError($event)" />
          </ng-container>
          <span *ngIf="!sickLeaveForm.get('SignatureText')?.value" class="field-line medium"></span>
        </div>
      </div>
    </div>

    <button type="submit" class="submit-btn" [disabled]="sickLeaveForm.invalid || isSubmitting">
      {{ isSubmitting ? 'Issuing...' : 'Issue Sick Leave Certificate' }}
    </button>
  </form>

  <div class="sick-leaves-list">
    <h3>Sick Leave Records</h3>
    <div class="tabs">
      <button type="button" [class.active-tab]="currentTab === 'pending'" (click)="currentTab = 'pending'">Pending</button>
      <button type="button" [class.active-tab]="currentTab === 'completed'" (click)="currentTab = 'completed'">Completed</button>
    </div>
    <div *ngIf="currentTab === 'pending'">
      <div class="table-container" *ngIf="activeSickLeaves.length > 0; else noPending">
        <table class="sick-leaves-table">
          <thead>
            <tr>
              <th>Certificate ID</th>
              <th>Employee Name</th>
              <th>Diagnosis</th>
              <th>Start Date</th>
              <th>End Date</th>
              <th>Total Days</th>
              <th>Doctor Name</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let leave of activeSickLeaves">
              <td>{{ leave.certificateID }}</td>
              <td>{{ leave.employeeName }}</td>
              <td>{{ leave.diagnosis }}</td>
              <td>{{ leave.startDate | date:'short' }}</td>
              <td>{{ leave.endDate | date:'short' }}</td>
              <td>{{ leave.totalDays }}</td>
              <td>{{ leave.doctorName }}</td>
              <td>
                <span class="status-badge" [ngClass]="leave.status">
                  {{ leave.status | titlecase }}
                </span>
              </td>
              <td>
                <button type="button" *ngIf="leave.status === 'Active'" class="action-btn complete"
                  (click)="updateLeaveStatus(leave.certificateID, 'Completed')">
                  Mark Complete
                </button>
                <button type="button" *ngIf="leave.status === 'Active'" class="action-btn cancel"
                  (click)="updateLeaveStatus(leave.certificateID, 'Cancelled')">
                  Cancel
                </button>
                <button type="button" class="action-btn print" (click)="openPrintModal(leave)">Print</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <ng-template #noPending>
        <div class="no-results">No pending sick leaves found.</div>
      </ng-template>
    </div>

    <div *ngIf="currentTab === 'completed'">
      <div class="table-container" *ngIf="completedSickLeaves.length > 0; else noCompleted">
        <table class="sick-leaves-table">
          <thead>
            <tr>
              <th>Certificate ID</th>
              <th>Employee Name</th>
              <th>Diagnosis</th>
              <th>Start Date</th>
              <th>End Date</th>
              <th>Total Days</th>
              <th>Doctor Name</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let leave of completedSickLeaves">
              <td>{{ leave.certificateID }}</td>
              <td>{{ leave.employeeName }}</td>
              <td>{{ leave.diagnosis }}</td>
              <td>{{ leave.startDate | date:'short' }}</td>
              <td>{{ leave.endDate | date:'short' }}</td>
              <td>{{ leave.totalDays }}</td>
              <td>{{ leave.doctorName }}</td>
              <td>
                <span class="status-badge" [ngClass]="leave.status">
                  {{ leave.status | titlecase }}
                </span>
              </td>
              <td>
                <button type="button" *ngIf="leave.status === 'Active'" class="action-btn complete"
                  (click)="updateLeaveStatus(leave.certificateID, 'Completed')">
                  Mark Complete
                </button>
                <button type="button" *ngIf="leave.status === 'Active'" class="action-btn cancel"
                  (click)="updateLeaveStatus(leave.certificateID, 'Cancelled')">
                  Cancel
                </button>
                <button type="button" class="action-btn print" (click)="openPrintModal(leave)">Print</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <ng-template #noCompleted>
        <div class="no-results">No completed sick leaves found.</div>
      </ng-template>
    </div>
  </div>

  <div class="modal-overlay" *ngIf="showPrintModal" (click)="closePrintModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Medical Certificate</h3>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="printCertificate()">üñ®Ô∏è Print</button>
          <button type="button" class="btn-secondary" (click)="downloadCertificate()">üì• Download</button>
          <button type="button" class="btn-close" (click)="closePrintModal()">‚úï</button>
        </div>
      </div>

      <div class="certificate-container" id="printable-certificate">
        <div class="certificate-header">
          <div class="header-left">
            <div class="logo-container">
              <img [src]="logoPath" alt="FHC Logo" class="logo-image" />
            </div>
          </div>
          
          <div class="header-center">
            <div class="clinic-title">FEDERAL HOUSING COOPERATION MEDIUM CLINIC</div>
            <div class="clinic-phone">TEL. 011-855-3615</div>
          </div>
          
          <div class="header-right">
            <div class="card-info">
              <span class="amharic-text">·ä´·à≠·ãµ ·âÅ·å•·à≠</span>
              <span class="english-label">Card No</span>
              <span class="field-line">{{ selectedLeave?.employeeID || '' }}</span>
            </div>
          </div>
        </div>

        <div class="date-section">
          <span class="date-label">Date</span>
          <span class="date-underline">{{ selectedLeave?.issueDate | date:'MM/dd/yyyy' || '' }}</span>
        </div>

        <div class="certificate-title">Medical Certificate</div>

        <div class="form-section">
          <div class="form-row-cert">
            <div class="field-group">
              <span class="amharic-label">·àµ·àù</span>
              <span class="field-separator">/</span>
              <span class="english-label">Name</span>
              <span class="field-line">{{ selectedLeave?.employeeName || '' }}</span>
            </div>
            <div class="field-group">
              <span class="amharic-label">·ãï·ãµ·àú</span>
              <span class="field-separator">/</span>
              <span class="english-label">Age</span>
              <span class="field-line">{{ selectedLeave?.age || '' }}</span>
            </div>
            <div class="field-group">
              <span class="amharic-label">·çÜ·â≥</span>
              <span class="field-separator">/</span>
              <span class="english-label">Sex</span>
              <span class="field-line">{{ selectedLeave?.sex || '' }}</span>
            </div>
          </div>

          <div class="form-row-cert single">
            <div class="field-group full">
              <span class="amharic-label">·ä†·ãµ·à´·àª</span>
              <span class="field-separator">/</span>
              <span class="english-label">Address</span>
              <span class="field-line long">{{ selectedLeave?.address || '' }}</span>
            </div>
          </div>

          <div class="form-row-cert single">
            <div class="field-group full">
              <span class="amharic-label">·â∞·àò·à®·àò·à©·â†·âµ ·âÄ·äï</span>
              <span class="field-separator">/</span>
              <span class="english-label">Examined on</span>
              <span class="field-line long">{{ selectedLeave?.examinedOn | date:'MM/dd/yyyy' || '' }}</span>
            </div>
          </div>

          <div class="form-row-cert single">
            <div class="field-group full">
              <span class="amharic-label">·ã®·àù·à≠·àò·à´ ·ãç·å§·âµ</span>
              <span class="field-separator">/</span>
              <span class="english-label">Diagnosis</span>
              <span class="field-line long">{{ selectedLeave?.diagnosis || '' }}</span>
            </div>
          </div>

          <div class="form-row-cert single">
            <div class="field-group full">
              <span class="amharic-label">·ã®·àÄ·ä™·àù ·ä†·àµ·â∞·ã´·ã®·âµ</span>
              <span class="field-separator">/</span>
              <span class="english-label">Doctor's recommendation</span>
              <span class="field-line long">{{ selectedLeave?.recommendations || '' }}</span>
            </div>
          </div>

          <div class="form-row-cert single">
            <div class="field-group full">
              <span class="amharic-label">·ã®·àö·ã´·àµ·çà·àç·åà·ãç ·ãï·à®·çç·âµ</span>
              <span class="field-separator">/</span>
              <span class="english-label">Rest required</span>
              <span class="field-line long">
                {{ selectedLeave?.totalDays }} days ({{ selectedLeave?.startDate | date:'MM/dd/yyyy' }} - {{ selectedLeave?.endDate | date:'MM/dd/yyyy' }})
              </span>
            </div>
          </div>

          <div class="form-row-cert single">
            <div class="field-group full">
              <span class="amharic-label">·ã®·àê·ä™·àô ·àµ·àù</span>
              <span class="field-separator">/</span>
              <span class="english-label">Doctor's name</span>
              <span class="field-line long">{{ selectedLeave?.doctorName || '' }}</span>
            </div>
          </div>

          <div class="form-row-cert single">
            <div class="field-group full">
              <span class="amharic-label">·çä·à≠·àõ</span>
              <span class="field-separator">/</span>
              <span class="english-label">Signature</span>
              <ng-container *ngIf="selectedLeave?.signature">
                <img [src]="'data:image/png;base64,' + (selectedLeave?.signature || '')" class="signature-image" alt="Doctor's Signature" />
              </ng-container>
              <span *ngIf="!selectedLeave?.signature" class="field-line medium"></span>
            </div>
          </div>

          <div class="form-row-cert single">
            <div class="field-group full">
              <span class="amharic-label">·âÄ·äï</span>
              <span class="field-separator">/</span>
              <span class="english-label">Date</span>
              <span class="field-line medium">{{ selectedLeave?.issueDate | date:'MM/dd/yyyy' || '' }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>