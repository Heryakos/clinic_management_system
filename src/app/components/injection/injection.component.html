<div class="injection-container">
  <h2>Procedure Room Management</h2>

  <!-- Procedure Type Tabs -->
  <div class="procedure-tabs-container">
      <div class="procedure-tabs">
          <button type="button" class="procedure-tab-button" [class.active]="selectedProcedureTab === 'injections'" 
              (click)="selectProcedureTab('injections')">
              ðŸ’‰ Injections
          </button>
          <button type="button" class="procedure-tab-button" [class.active]="selectedProcedureTab === 'wound-care'" 
              (click)="selectProcedureTab('wound-care')">
              ðŸ©¹ Wound Care
          </button>
          <button type="button" class="procedure-tab-button" [class.active]="selectedProcedureTab === 'suturing'" 
              (click)="selectProcedureTab('suturing')">
              ðŸª¡ Suturing
          </button>
          <button type="button" class="procedure-tab-button" [class.active]="selectedProcedureTab === 'ear-irrigation'" 
              (click)="selectProcedureTab('ear-irrigation')">
              ðŸ‘‚ Ear Irrigation
          </button>
      </div>
  </div>

  <!-- Main Content Tabs -->
  <div class="tabs-container" *ngIf="selectedProcedureTab === 'injections'">
      <div class="tabs">
          <button type="button" class="tab-button" [class.active]="selectedTab === 'today'" 
              (click)="selectTab('today')">
              Today's Schedule
          </button>
          <button type="button" class="tab-button" [class.active]="selectedTab === 'all'" 
              (click)="selectTab('all')">
              All Active Injections
          </button>
          <button type="button" class="tab-button" [class.active]="selectedTab === 'patient'" 
              (click)="selectTab('patient')">
              Patient Search
          </button>
      </div>
  </div>

  <!-- Loading Indicator -->
  <div *ngIf="isLoading" class="loading-container">
      <div class="loading-spinner"></div>
      <p>Loading...</p>
  </div>

  <!-- Wound Care Tab -->
  <div *ngIf="selectedProcedureTab === 'wound-care' && !isLoading" class="procedure-section">
      <div class="section-header">
          <h3>ðŸ©¹ Wound Care Procedures</h3>
          <button type="button" class="refresh-btn" (click)="refreshData()">
              <span>â†»</span> Refresh
          </button>
      </div>

      <div *ngIf="todayProcedures.length === 0" class="no-data">
          <p>No wound care procedures scheduled for today</p>
      </div>

      <div *ngIf="todayProcedures.length > 0" class="procedures-grid">
          <ng-container *ngFor="let procedure of todayProcedures">
              <div *ngIf="procedure.procedureType === 'WoundCare'" class="procedure-card">
              <div class="card-header">
                  <div class="status-badge" [ngClass]="getScheduleStatusClass(procedure.status)">
                      {{ procedure.status || 'Unknown' }}
                  </div>
                  <div class="procedure-time">
                      {{ procedure.procedureDate | date:'shortTime' }}
                  </div>
              </div>

              <div class="card-body">
                  <div class="patient-info">
                      <h4>ðŸ©¹ Wound Care #{{ procedure.procedureID || 'N/A' }}</h4>
                      <p>Patient: {{ procedure.patientName || 'Unknown' }}</p>
                      <p>Wound Type: {{ procedure.woundType || 'N/A' }}</p>
                      <p>Location: {{ procedure.woundLocation || 'N/A' }}</p>
                      <p>Treatment: {{ procedure.treatmentPlan || 'N/A' }}</p>
                  </div>

                  <div class="procedure-actions">
                      <button type="button" class="action-btn view-btn" 
                          (click)="viewInjectionDetails(procedure.procedureID, procedure.patientID)">
                          View Details
                      </button>
                      <button type="button" *ngIf="procedure.status === 'Pending'" 
                          class="action-btn administer-btn" 
                          (click)="administerProcedure(procedure.procedureID, 'WoundCare')">
                          Administer
                      </button>
                  </div>
              </div>
              </div>
          </ng-container>
      </div>
  </div>

  <!-- Suturing Tab -->
  <div *ngIf="selectedProcedureTab === 'suturing' && !isLoading" class="procedure-section">
      <div class="section-header">
          <h3>ðŸª¡ Suturing Procedures</h3>
          <button type="button" class="refresh-btn" (click)="refreshData()">
              <span>â†»</span> Refresh
          </button>
      </div>

      <div *ngIf="todayProcedures.length === 0" class="no-data">
          <p>No suturing procedures scheduled for today</p>
      </div>

      <div *ngIf="todayProcedures.length > 0" class="procedures-grid">
          <ng-container *ngFor="let procedure of todayProcedures">
              <div *ngIf="procedure.procedureType === 'Suturing'" class="procedure-card">
              <div class="card-header">
                  <div class="status-badge" [ngClass]="getScheduleStatusClass(procedure.status)">
                      {{ procedure.status || 'Unknown' }}
                  </div>
                  <div class="procedure-time">
                      {{ procedure.procedureDate | date:'shortTime' }}
                  </div>
              </div>

              <div class="card-body">
                  <div class="patient-info">
                      <h4>ðŸª¡ Suturing #{{ procedure.procedureID || 'N/A' }}</h4>
                      <p>Patient: {{ procedure.patientName || 'Unknown' }}</p>
                      <p>Wound Type: {{ procedure.woundType || 'N/A' }}</p>
                      <p>Location: {{ procedure.woundLocation || 'N/A' }}</p>
                      <p>Suture Type: {{ procedure.sutureType || 'N/A' }}</p>
                  </div>

                  <div class="procedure-actions">
                      <button type="button" class="action-btn view-btn" 
                          (click)="viewInjectionDetails(procedure.procedureID, procedure.patientID)">
                          View Details
                      </button>
                      <button type="button" *ngIf="procedure.status === 'Pending'" 
                          class="action-btn administer-btn" 
                          (click)="administerProcedure(procedure.procedureID, 'Suturing')">
                          Administer
                      </button>
                  </div>
              </div>
              </div>
          </ng-container>
      </div>
  </div>

  <!-- Ear Irrigation Tab -->
  <div *ngIf="selectedProcedureTab === 'ear-irrigation' && !isLoading" class="procedure-section">
      <div class="section-header">
          <h3>ðŸ‘‚ Ear Irrigation Procedures</h3>
          <button type="button" class="refresh-btn" (click)="refreshData()">
              <span>â†»</span> Refresh
          </button>
      </div>

      <div *ngIf="todayProcedures.length === 0" class="no-data">
          <p>No ear irrigation procedures scheduled for today</p>
      </div>

      <div *ngIf="todayProcedures.length > 0" class="procedures-grid">
          <ng-container *ngFor="let procedure of todayProcedures">
              <div *ngIf="procedure.procedureType === 'EarIrrigation'" class="procedure-card">
              <div class="card-header">
                  <div class="status-badge" [ngClass]="getScheduleStatusClass(procedure.status)">
                      {{ procedure.status || 'Unknown' }}
                  </div>
                  <div class="procedure-time">
                      {{ procedure.procedureDate | date:'shortTime' }}
                  </div>
              </div>

              <div class="card-body">
                  <div class="patient-info">
                      <h4>ðŸ‘‚ Ear Irrigation #{{ procedure.procedureID || 'N/A' }}</h4>
                      <p>Patient: {{ procedure.patientName || 'Unknown' }}</p>
                      <p>Ear Side: {{ procedure.earSide || 'N/A' }}</p>
                      <p>Solution: {{ procedure.irrigationSolution || 'N/A' }}</p>
                      <p>Temperature: {{ procedure.solutionTemperature || 'N/A' }}</p>
                  </div>

                  <div class="procedure-actions">
                      <button type="button" class="action-btn view-btn" 
                          (click)="viewInjectionDetails(procedure.procedureID, procedure.patientID)">
                          View Details
                      </button>
                      <button type="button" *ngIf="procedure.status === 'Pending'" 
                          class="action-btn administer-btn" 
                          (click)="administerProcedure(procedure.procedureID, 'EarIrrigation')">
                          Administer
                      </button>
                  </div>
              </div>
              </div>
          </ng-container>
      </div>
  </div>

  <!-- Today's Schedule Tab -->
  <div *ngIf="selectedTab === 'today' && selectedProcedureTab === 'injections' && !isLoading" class="schedule-section">
      <div class="section-header">
          <h3>Today's Injection Schedule</h3>
          <button type="button" class="refresh-btn" (click)="refreshData()">
              <span>â†»</span> Refresh
          </button>
      </div>

      <div *ngIf="todaySchedules.length === 0" class="no-data">
          <p>No injections scheduled for today</p>
      </div>

      <div *ngIf="todaySchedules.length > 0" class="schedules-grid">
          <div *ngFor="let schedule of todaySchedules" class="schedule-card">
              <div class="card-header">
                  <div class="status-badge" [ngClass]="getScheduleStatusClass(schedule.status)">
                      {{ schedule.status || 'Unknown' }}
                  </div>
                  <div class="schedule-time">
                      {{ schedule.scheduledDate | date:'shortTime' }}
                  </div>
              </div>

              <div class="card-body">
                  <div class="patient-info">
                      <h4>Schedule #{{ schedule.scheduleID || 'N/A' }}</h4>
                      <p>Patient: {{ schedule.patientName || schedule.fullName || 'Unknown' }}</p>
                      <p>Medication: {{ schedule.medicationName || 'N/A' }}</p>
                  </div>

                  <div class="schedule-actions">
                      <button type="button" class="action-btn view-btn" 
                          (click)="viewInjectionDetails(schedule.injectionID, schedule.patientID)">
                          View Details
                      </button>
                      <button type="button" *ngIf="schedule.status === 'Pending'" 
                          class="action-btn administer-btn" 
                          (click)="administerScheduledInjection(schedule)">
                          Administer
                      </button>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <!-- All Active Injections Tab -->
  <div *ngIf="selectedTab === 'all' && selectedProcedureTab === 'injections' && !isLoading" class="injections-section">
      <div class="section-header">
          <h3>Active Injections</h3>
          <button type="button" class="refresh-btn" (click)="refreshData()">
              <span>â†»</span> Refresh
          </button>
      </div>

      <div *ngIf="globalActiveInjections.length === 0" class="no-data">
          <p>No active injections found</p>
      </div>

      <div *ngIf="globalActiveInjections.length > 0" class="table-container">
          <table class="injections-table">
              <thead>
                  <tr>
                      <th>Injection #</th>
                      <th>Patient</th>
                      <th>Medication</th>
                      <th>Frequency</th>
                      <th>Progress</th>
                      <th>Start Date</th>
                      <th>End Date</th>
                      <th>Status</th>
                      <th>Actions</th>
                  </tr>
              </thead>
              <tbody>
                  <tr *ngFor="let injection of globalActiveInjections">
                      <td>{{ injection.injectionNumber || 'N/A' }}</td>
                      <td>
                          <div class="patient-cell">
                              <div class="patient-name">{{ injection.fullName || 'Unknown' }}</div>
                              <div class="patient-card">Card: {{ injection.cardNumber || 'N/A' }}</div>
                          </div>
                      </td>
                      <td>
                          <div class="medication-cell">
                              <div class="med-name">{{ injection.medicationName || 'N/A' }}</div>
                              <div class="med-details">{{ injection.strength || '' }} {{ injection.dosageForm || '' }}</div>
                          </div>
                      </td>
                      <td>{{ injection.frequency || 'N/A' }}</td>
                      <td>
                          <div class="progress-container">
                              <div class="progress-bar">
                                  <div class="progress-fill" 
                                      [ngClass]="getProgressBarClass(getScheduleProgress(injection))" 
                                      [style.width.%]="getScheduleProgress(injection)">
                                  </div>
                              </div>
                              <div class="progress-text">
                                  {{ injection.administeredDoses || 0 }} / {{ injection.totalDoses || 0 }}
                              </div>
                          </div>
                      </td>
                      <td>{{ injection.startDate | date:'short' }}</td>
                      <td>{{ injection.endDate | date:'short' }}</td>
                      <td>
                          <span class="status-badge" [ngClass]="getScheduleStatusClass(injection.status)">
                              {{ injection.status || 'Unknown' }}
                          </span>
                      </td>
                      <td>
                          <button type="button" class="action-btn view-btn-small" 
                              (click)="viewInjectionDetails(injection.injectionID, injection.patientID)">
                              View Details
                          </button>
                          <!-- <button type="button" class="action-btn administer" 
                              (click)="administerInjection(injection.injectionID)" 
                              *ngIf="injection.status === 'Active'">
                              Administer
                          </button> -->
                      </td>
                  </tr>
              </tbody>
          </table>
      </div>
  </div>

  <!-- Patient Search Tab -->
  <div *ngIf="selectedTab === 'patient' && selectedProcedureTab === 'injections' && !isLoading" class="patient-search-section">
      <div class="search-container">
          <form [formGroup]="searchForm" (ngSubmit)="onSearchPatient()" class="search-form">
              <div class="form-group">
                  <label for="patientID">Card Number:</label>
                  <input type="text" id="patientID" formControlName="patientID" class="form-control" 
                      placeholder="Enter card number">
                  <div class="error-message" 
                      *ngIf="searchForm.get('patientID')?.invalid && searchForm.get('patientID')?.touched">
                      Card number is required
                  </div>
              </div>
              <button type="submit" class="submit-btn" [disabled]="searchForm.invalid || isSearching">
                  {{ isSearching ? 'Searching...' : 'Search Patient' }}
              </button>
          </form>
      </div>

      <div class="patient-info" *ngIf="patient">
          <h3>Patient Information</h3>
          <div class="form-row">
              <div class="form-group">
                  <label>Patient Name:</label>
                  <span>{{ patient.firstName }} {{ patient.lastName }}</span>
              </div>
              <div class="form-group">
                  <label>Card Number:</label>
                  <span>{{ patient.cardNumber }}</span>
              </div>
              <div class="form-group">
                  <label>Age:</label>
                  <span>{{ patient.age }}</span>
              </div>
              <div class="form-group">
                  <label>Gender:</label>
                  <span>{{ patient.gender }}</span>
              </div>
          </div>
      </div>

      <div class="injections-list" *ngIf="patient">
          <h3>Patient Injection Requests</h3>
          <div class="table-container">
              <table class="injections-table">
                  <thead>
                      <tr>
                          <th>Injection Number</th>
                          <th>Injection Date</th>
                          <th>Status</th>
                          <th>Physician</th>
                          <th>Administered By</th>
                          <th>Actions</th>
                      </tr>
                  </thead>
                  <tbody>
                      <tr *ngFor="let injection of injections">
                          <td>{{ injection.injectionNumber || 'N/A' }}</td>
                          <td>{{ injection.injectionDate | date:'short' }}</td>
                          <td>{{ injection.status || 'Unknown' }}</td>
                          <td>{{ injection.orderingPhysicianName || 'N/A' }}</td>
                          <td>{{ injection.administeredByName || 'N/A' }}</td>
                          <td>
                              <button type="button" class="action-btn view" 
                                  (click)="viewInjectionDetails(injection.injectionID, patient.patientID)">
                                  View Details
                              </button>
                              <!-- <button type="button" class="action-btn administer" 
                                  (click)="administerInjection(injection.injectionID)" 
                                  *ngIf="injection.status === 'Active'">
                                  Administer
                              </button> -->
                          </td>
                      </tr>
                  </tbody>
              </table>
          </div>
      </div>
  </div>

  <!-- All Active Wound Care Tab -->
  <div *ngIf="selectedTab === 'all' && selectedProcedureTab === 'wound-care' && !isLoading" class="procedure-section">
      <div class="section-header">
          <h3>All Active Wound Care Procedures</h3>
          <button type="button" class="refresh-btn" (click)="refreshData()">
              <span>â†»</span> Refresh
          </button>
      </div>

      <div *ngIf="woundCareProcedures.length === 0" class="no-data">
          <p>No active wound care procedures found</p>
      </div>

      <div *ngIf="woundCareProcedures.length > 0" class="table-container">
          <table class="procedures-table">
              <thead>
                  <tr>
                      <th>Wound Care Number</th>
                      <th>Patient</th>
                      <th>Wound Type</th>
                      <th>Location</th>
                      <th>Treatment Plan</th>
                      <th>Status</th>
                      <th>Actions</th>
                  </tr>
              </thead>
              <tbody>
                  <tr *ngFor="let procedure of woundCareProcedures">
                      <td>{{ procedure.woundCareNumber || procedure.procedureNumber }}</td>
                      <td>{{ procedure.patientName || 'Unknown' }}</td>
                      <td>{{ procedure.woundType || 'N/A' }}</td>
                      <td>{{ procedure.woundLocation || 'N/A' }}</td>
                      <td>{{ procedure.treatmentPlan || 'N/A' }}</td>
                      <td>
                          <span class="status-badge" [ngClass]="getScheduleStatusClass(procedure.status)">
                              {{ procedure.status }}
                          </span>
                      </td>
                      <td>
                          <button type="button" class="action-btn view-btn" 
                              (click)="viewInjectionDetails(procedure.woundCareID || procedure.procedureID, procedure.patientID)">
                              View Details
                          </button>
                          <button type="button" *ngIf="procedure.status === 'Active'" 
                              class="action-btn administer-btn" 
                              (click)="administerProcedure(procedure.woundCareID || procedure.procedureID, 'WoundCare')">
                              Administer
                          </button>
                      </td>
                  </tr>
              </tbody>
          </table>
      </div>
  </div>

  <!-- All Active Suturing Tab -->
  <div *ngIf="selectedTab === 'all' && selectedProcedureTab === 'suturing' && !isLoading" class="procedure-section">
      <div class="section-header">
          <h3>All Active Suturing Procedures</h3>
          <button type="button" class="refresh-btn" (click)="refreshData()">
              <span>â†»</span> Refresh
          </button>
      </div>

      <div *ngIf="suturingProcedures.length === 0" class="no-data">
          <p>No active suturing procedures found</p>
      </div>

      <div *ngIf="suturingProcedures.length > 0" class="table-container">
          <table class="procedures-table">
              <thead>
                  <tr>
                      <th>Suturing Number</th>
                      <th>Patient</th>
                      <th>Wound Type</th>
                      <th>Location</th>
                      <th>Suture Type</th>
                      <th>Status</th>
                      <th>Actions</th>
                  </tr>
              </thead>
              <tbody>
                  <tr *ngFor="let procedure of suturingProcedures">
                      <td>{{ procedure.suturingNumber || procedure.procedureNumber }}</td>
                      <td>{{ procedure.patientName || 'Unknown' }}</td>
                      <td>{{ procedure.woundType || 'N/A' }}</td>
                      <td>{{ procedure.woundLocation || 'N/A' }}</td>
                      <td>{{ procedure.sutureType || 'N/A' }}</td>
                      <td>
                          <span class="status-badge" [ngClass]="getScheduleStatusClass(procedure.status)">
                              {{ procedure.status }}
                          </span>
                      </td>
                      <td>
                          <button type="button" class="action-btn view-btn" 
                              (click)="viewInjectionDetails(procedure.suturingID || procedure.procedureID, procedure.patientID)">
                              View Details
                          </button>
                          <button type="button" *ngIf="procedure.status === 'Active'" 
                              class="action-btn administer-btn" 
                              (click)="administerProcedure(procedure.suturingID || procedure.procedureID, 'Suturing')">
                              Administer
                          </button>
                      </td>
                  </tr>
              </tbody>
          </table>
      </div>
  </div>

  <!-- All Active Ear Irrigation Tab -->
  <div *ngIf="selectedTab === 'all' && selectedProcedureTab === 'ear-irrigation' && !isLoading" class="procedure-section">
      <div class="section-header">
          <h3>All Active Ear Irrigation Procedures</h3>
          <button type="button" class="refresh-btn" (click)="refreshData()">
              <span>â†»</span> Refresh
          </button>
      </div>

      <div *ngIf="earIrrigationProcedures.length === 0" class="no-data">
          <p>No active ear irrigation procedures found</p>
      </div>

      <div *ngIf="earIrrigationProcedures.length > 0" class="table-container">
          <table class="procedures-table">
              <thead>
                  <tr>
                      <th>Ear Irrigation Number</th>
                      <th>Patient</th>
                      <th>Ear Side</th>
                      <th>Solution</th>
                      <th>Temperature</th>
                      <th>Status</th>
                      <th>Actions</th>
                  </tr>
              </thead>
              <tbody>
                  <tr *ngFor="let procedure of earIrrigationProcedures">
                      <td>{{ procedure.earIrrigationNumber || procedure.procedureNumber }}</td>
                      <td>{{ procedure.patientName || 'Unknown' }}</td>
                      <td>{{ procedure.earSide || 'N/A' }}</td>
                      <td>{{ procedure.irrigationSolution || 'N/A' }}</td>
                      <td>{{ procedure.solutionTemperature || 'N/A' }}</td>
                      <td>
                          <span class="status-badge" [ngClass]="getScheduleStatusClass(procedure.status)">
                              {{ procedure.status }}
                          </span>
                      </td>
                      <td>
                          <button type="button" class="action-btn view-btn" 
                              (click)="viewInjectionDetails(procedure.earIrrigationID || procedure.procedureID, procedure.patientID)">
                              View Details
                          </button>
                          <button type="button" *ngIf="procedure.status === 'Active'" 
                              class="action-btn administer-btn" 
                              (click)="administerProcedure(procedure.earIrrigationID || procedure.procedureID, 'EarIrrigation')">
                              Administer
                          </button>
                      </td>
                  </tr>
              </tbody>
          </table>
      </div>
  </div>
</div>