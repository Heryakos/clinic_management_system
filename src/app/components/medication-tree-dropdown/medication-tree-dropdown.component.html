<div class="medication-tree-dropdown" #dropdownContainer>
  <div 
    class="dropdown-trigger" 
    [class.error]="error" 
    [class.disabled]="disabled"
    [class.open]="isOpen"
    (click)="toggleDropdown()">
    <span class="display-value" [class.placeholder]="!selectedMedication">
      {{ displayValue }}
    </span>
    <span class="dropdown-arrow" [class.rotated]="isOpen">‚ñº</span>
  </div>

  <div class="error-message" *ngIf="error">{{ error }}</div>

  <div class="dropdown-menu" *ngIf="isOpen">
    <!-- Search Input -->
    <div class="search-container">
      <input 
        type="text" 
        class="search-input"
        placeholder="Search medications..."
        [(ngModel)]="searchTerm"
        (input)="onSearchChange()"
        (click)="$event.stopPropagation()">
      <button 
        type="button" 
        class="clear-search" 
        *ngIf="searchTerm"
        (click)="clearSearch()">√ó</button>
    </div>

    <!-- Items List -->
    <div class="items-content">
      <div *ngIf="filteredMedicationsByCategory.length === 0" class="no-results">
        No medications found
      </div>

      <div *ngFor="let category of filteredMedicationsByCategory" class="category-group">
        <!-- Category Header -->
        <div 
          class="category-header" 
          (click)="toggleCategory(category.categoryName)">
          <span class="expand-icon" [class.expanded]="isCategoryExpanded(category.categoryName)">
            {{ isCategoryExpanded(category.categoryName) ? '‚ñº' : '‚ñ∂' }}
          </span>
          <span class="category-icon">üè∑Ô∏è</span>
          <span class="category-name">{{ category.categoryName }}</span>
          <span class="item-count">({{ category.items.length }})</span>
        </div>

        <!-- Medications in Category -->
        <div *ngIf="isCategoryExpanded(category.categoryName)" class="category-items">
          <div 
            *ngFor="let item of category.items" 
            class="item-row"
            [class.low-stock]="item.currentStock !== undefined && item.minimumStock !== undefined && item.currentStock <= item.minimumStock"
            (click)="selectMedication(item, category.categoryName, item.dosageForm || 'Unknown')">
            <div class="item-info">
              <span class="item-icon">üíä</span>
              <div class="item-details">
                <span class="item-name">
                  {{ item.medicationName }}
                  <span *ngIf="item.strength" class="strength">({{ item.strength }})</span>
                </span>
                <span class="item-code" *ngIf="item.itemCode">({{ item.itemCode }})</span>
              </div>
            </div>
            <div class="stock-info" *ngIf="item.currentStock !== undefined && item.minimumStock !== undefined">
              <span class="stock-quantity" 
                    [class.low]="item.currentStock <= item.minimumStock"
                    [class.normal]="item.currentStock > item.minimumStock">
                {{ item.currentStock }} {{ item.unit || 'units' }}
              </span>
              <span class="stock-status" 
                    [class.low]="item.currentStock <= item.minimumStock">
                {{ item.currentStock <= item.minimumStock ? 'Low Stock' : 'Available' }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Original Dosage Form Structure (Commented Out) -->
      <!--
      <div *ngFor="let category of filteredMedications" class="category-item">
        <div 
          class="category-header" 
          (click)="toggleCategory(category.category)">
          <span class="expand-icon" [class.expanded]="isCategoryExpanded(category.category)">
            {{ isCategoryExpanded(category.category) ? '‚ñº' : '‚ñ∂' }}
          </span>
          <span class="category-icon">üè∑Ô∏è</span>
          <span class="category-name">{{ category.category }}</span>
          <span class="item-count">({{ getCategoryMedicationCount(category) }})</span>
        </div>
        <div *ngIf="isCategoryExpanded(category.category)" class="dosage-forms">
          <div *ngFor="let dosageForm of category.dosageForms" class="dosage-form-item">
            <div 
              class="dosage-form-header"
              (click)="toggleForm(category.category, dosageForm.form)">
              <span class="expand-icon" [class.expanded]="isFormExpanded(category.category, dosageForm.form)">
                {{ isFormExpanded(category.category, dosageForm.form) ? '‚ñº' : '‚ñ∂' }}
              </span>
              <span class="form-icon">üì¶</span>
              <span class="form-name">{{ dosageForm.form }}</span>
              <span class="item-count">({{ dosageForm.medications.length }})</span>
            </div>
            <div *ngIf="isFormExpanded(category.category, dosageForm.form)" class="medications">
              <div 
                *ngFor="let medication of dosageForm.medications" 
                class="medication-item"
                (click)="selectMedication(medication, category.category, dosageForm.form)">
                <span class="medication-icon">üíä</span>
                <span class="medication-name">
                  {{ medication.medicationName }}
                  <span *ngIf="medication.strength" class="strength">({{ medication.strength }})</span>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
      -->
    </div>
  </div>
</div>