<div class="referral-tab-container">
  <!-- No Patient Selected Message -->
  <div *ngIf="!patient" class="no-results">
    <div class="empty-state">
      <h3>No Patient Selected</h3>
      <p>Please select a patient to manage referrals.</p>
    </div>
  </div>

  <!-- Referral Content -->
  <div *ngIf="patient">
    <!-- Header Section -->
    <div class="referral-header">
      <div class="patient-info">
        <h3>{{ patient.FullName }} - Referral Management</h3>
        <p>Card Number: {{ patient.CardNumber }} | Patient ID: {{ patient.PatientID }}</p>
      </div>
      
      <!-- Referral Request Button -->
      <div class="referral-request-section">
        <button
          type="button"
          class="submit-btn"
          (click)="onReferralRequest()"
          [disabled]="isRequestingReferral"
        >
          <span class="btn-icon">+</span>
          {{ isRequestingReferral ? 'Processing...' : 'Create New Referral' }}
        </button>
      </div>
    </div>

    <!-- Referrals List -->
    <div *ngIf="referrals$ | async as referrals; else noReferrals">
      <div *ngIf="referrals.length > 0" class="referrals-list">
        <h4>Patient Referrals ({{ referrals.length }})</h4>
        <div class="referrals-grid">
          <div *ngFor="let referral of referrals" class="referral-card">
            <div class="referral-card-header">
              <div class="referral-icon">
                {{ getDepartmentIcon(referral.Department) }}
              </div>
              <div class="referral-info">
                <h5>{{ referral.Department }}</h5>
                <p class="referral-id">REF-{{ referral.ReferralID }}</p>
              </div>
              <div class="referral-status">
                <span [class]="getStatusClass(referral.Status)">
                  {{ referral.Status }}
                </span>
              </div>
            </div>
            
            <div class="referral-card-body">
              <div class="referral-detail">
                <label>Date:</label>
                <span>{{ formatDate(referral.ReferralDate) }}</span>
              </div>
              <div class="referral-detail" *ngIf="referral.Notes">
                <label>Notes:</label>
                <span>{{ referral.Notes }}</span>
              </div>
              <div class="referral-detail" *ngIf="referral.PhysicianName">
                <label>Physician:</label>
                <span>{{ referral.PhysicianName }}</span>
              </div>
            </div>
            
            <div class="referral-card-actions">
              <button
                  type="button"
                  class="action-btn view"
                  (click)="viewReferralDetails(referral.ReferralID)"
              >
                  View Details
              </button>
              <button
                  *ngIf="referral.Status === 'Pending'"
                  type="button"
                  class="action-btn progress"
                  (click)="updateReferralStatus(referral.ReferralID, 'In_Progress')"
              >
                  Start Progress
              </button>
              <button
                  *ngIf="referral.Status === 'In_Progress'"
                  type="button"
                  class="action-btn complete"
                  (click)="updateReferralStatus(referral.ReferralID, 'Completed')"
              >
                  Complete
              </button>
              <button
                  *ngIf="referral.Status !== 'Completed' && referral.Status !== 'Cancelled'"
                  type="button"
                  class="action-btn cancel"
                  (click)="updateReferralStatus(referral.ReferralID, 'Cancelled')"
              >
                  Cancel
              </button>
          </div>
          
          
          </div>
        </div>
      </div>
    </div>

    <!-- No Referrals Template -->
    <ng-template #noReferrals>
      <div class="no-data">
        <div class="empty-state">
          <div class="empty-icon">ðŸ“‹</div>
          <h4>No Referrals Found</h4>
          <p>No referrals have been created for this patient yet.</p>
          <button
            type="button"
            class="submit-btn"
            (click)="onReferralRequest()"
            [disabled]="isRequestingReferral"
          >
            Create First Referral
          </button>
        </div>
      </div>
    </ng-template>

    <!-- Referral Modal -->
    <app-referral-modal
      *ngIf="showReferralModal"
      [patient]="patient"
      [isSubmitting]="isRequestingReferral"
      [createdBy]="createdBy"
      (closeModal)="onCloseModal()"
      (submitReferral)="onReferralSubmit($event)"
    ></app-referral-modal>

    <!-- Referral Details Modal -->
    <div *ngIf="showReferralDetails && selectedReferral" class="referral-details-modal">
      <div class="modal-overlay" (click)="closeReferralDetails()"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h3>Referral Details - REF-{{ selectedReferral.ReferralID }}</h3>
          <button type="button" class="close-btn" (click)="closeReferralDetails()">Ã—</button>
        </div>
        <div class="modal-body">
          <div class="details-section">
            <h4>Basic Information</h4>
            <div class="detail-row">
              <label>Department:</label>
              <span>{{ selectedReferral.Department }}</span>
            </div>
            <div class="detail-row">
              <label>Status:</label>
              <span [class]="getStatusClass(selectedReferral.Status)">{{ selectedReferral.Status }}</span>
            </div>
            <div class="detail-row">
              <label>Date:</label>
              <span>{{ formatDate(selectedReferral.ReferralDate) }}</span>
            </div>
            <div class="detail-row" *ngIf="selectedReferral.CompletedDate">
              <label>Completed Date:</label>
              <span>{{ formatDate(selectedReferral.CompletedDate) }}</span>
            </div>
          </div>
          
          <div class="details-section" *ngIf="selectedReferral.ClinicalHistory || selectedReferral.CurrentDiagnosis">
            <h4>Clinical Information</h4>
            <div class="detail-row" *ngIf="selectedReferral.ClinicalHistory">
              <label>Clinical History:</label>
              <span>{{ selectedReferral.ClinicalHistory }}</span>
            </div>
            <div class="detail-row" *ngIf="selectedReferral.CurrentDiagnosis">
              <label>Current Diagnosis:</label>
              <span>{{ selectedReferral.CurrentDiagnosis }}</span>
            </div>
          </div>
          
          <div class="details-section" *ngIf="selectedReferral.VitalSignsBloodPressure || selectedReferral.VitalSignsHeartRate">
            <h4>Vital Signs</h4>
            <div class="vital-signs-grid">
              <div *ngIf="selectedReferral.VitalSignsBloodPressure" class="vital-sign">
                <label>Blood Pressure:</label>
                <span>{{ selectedReferral.VitalSignsBloodPressure }}</span>
              </div>
              <div *ngIf="selectedReferral.VitalSignsHeartRate" class="vital-sign">
                <label>Heart Rate:</label>
                <span>{{ selectedReferral.VitalSignsHeartRate }}</span>
              </div>
              <div *ngIf="selectedReferral.VitalSignsTemperature" class="vital-sign">
                <label>Temperature:</label>
                <span>{{ selectedReferral.VitalSignsTemperature }}</span>
              </div>
              <div *ngIf="selectedReferral.VitalSignsWeight" class="vital-sign">
                <label>Weight:</label>
                <span>{{ selectedReferral.VitalSignsWeight }}</span>
              </div>
              <div *ngIf="selectedReferral.VitalSignsHeight" class="vital-sign">
                <label>Height:</label>
                <span>{{ selectedReferral.VitalSignsHeight }}</span>
              </div>
            </div>
          </div>
          
          <div class="details-section" *ngIf="selectedReferral.PhysicianName">
            <h4>Physician Information</h4>
            <div class="detail-row">
              <label>Physician Name:</label>
              <span>{{ selectedReferral.PhysicianName }}</span>
            </div>
            <div class="detail-row" *ngIf="selectedReferral.PhysicianLicense">
              <label>License:</label>
              <span>{{ selectedReferral.PhysicianLicense }}</span>
            </div>
            <div class="detail-row" *ngIf="selectedReferral.PhysicianPhone">
              <label>Phone:</label>
              <span>{{ selectedReferral.PhysicianPhone }}</span>
            </div>
          </div>
          
          <div class="details-section" *ngIf="selectedReferral.Notes || selectedReferral.AdditionalNotes">
            <h4>Notes</h4>
            <div class="detail-row" *ngIf="selectedReferral.Notes">
              <label>Notes:</label>
              <span>{{ selectedReferral.Notes }}</span>
            </div>
            <div class="detail-row" *ngIf="selectedReferral.AdditionalNotes">
              <label>Additional Notes:</label>
              <span>{{ selectedReferral.AdditionalNotes }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
