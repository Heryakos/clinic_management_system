<div class="referral-tab-container">
  <div *ngIf="!patient" class="no-results">
    <div class="empty-state">
      <h3>No Patient Selected</h3>
      <p>Please select a patient to manage referrals.</p>
    </div>
  </div>

  <div *ngIf="patient">
    <div class="referral-header">
      <div class="patient-info">
        <h3>{{ patient.FullName }} - External Referral Management</h3>
        <p>Card Number: {{ patient.CardNumber }} | Patient ID: {{ patient.PatientID }}</p>
      </div>
      
      <div class="referral-request-section">
        <button
          type="button"
          class="submit-btn"
          (click)="onReferralRequest()"
          [disabled]="isRequestingReferral"
        >
          <span class="btn-icon">+</span>
          {{ isRequestingReferral ? 'Processing...' : 'Create New Referral' }}
        </button>
      </div>
    </div>

    <!-- Referrals List -->
    <div *ngIf="referrals$ | async as referrals; else noReferrals">
      <div *ngIf="referrals.length > 0" class="referrals-list">
        <h4>Patient Referrals ({{ referrals.length }})</h4>
        <div class="referrals-grid">
          <div *ngFor="let referral of referrals" class="referral-card">
            <div class="referral-card-header">
              <div class="referral-icon">üè•</div>
              <div class="referral-info">
                <h5>To: {{ referral.referredTo }}</h5>
                <p class="referral-id">{{ referral.referralNumber }}</p>
              </div>
              <div class="referral-status">
                <span [class]="getStatusClass(referral.status)">
                  {{ referral.status }}
                </span>
              </div>
            </div>
            
            <div class="referral-card-body">
              <div class="referral-detail">
                <label>Date:</label>
                <span>{{ formatDate(referral.referralDate) }}</span>
              </div>
              <div class="referral-detail">
                <label>Reason:</label>
                <span>{{ (referral.reasonForReferral || '') | slice:0:50 }}{{ (referral.reasonForReferral?.length || 0) > 50 ? '...' : '' }}</span>
              </div>
              <div class="referral-detail" *ngIf="referral.clinicalFindings">
                <label>Findings:</label>
                <span>{{ (referral.clinicalFindings || '') | slice:0:50 }}{{ (referral.clinicalFindings?.length || 0) > 50 ? '...' : '' }}</span>
              </div>
            </div>
            
            <div class="referral-card-actions">
              <button type="button" class="action-btn view" (click)="viewReferralDetails(referral.referralID)">
                View Details
              </button>
              <button *ngIf="referral.status === 'Pending'" type="button" class="action-btn progress"
                (click)="updateReferralStatus(referral.referralID, 'In_Progress')">
                Start Progress
              </button>
              <button *ngIf="referral.status === 'In_Progress'" type="button" class="action-btn complete"
                (click)="updateReferralStatus(referral.referralID, 'Completed')">
                Complete
              </button>
              <button *ngIf="referral.status !== 'Completed' && referral.status !== 'Cancelled'" 
                type="button" class="action-btn cancel"
                (click)="updateReferralStatus(referral.referralID, 'Cancelled')">
                Cancel
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- No Referrals Message -->
    <ng-template #noReferrals>
      <div class="no-data">
        <div class="empty-state">
          <div class="empty-icon">üìã</div>
          <h4>No Referrals Found</h4>
          <p>No external referrals have been created for this patient yet.</p>
          <button type="button" class="submit-btn" (click)="onReferralRequest()">
            Create First Referral
          </button>
        </div>
      </div>
    </ng-template>

    <!-- Referral Modal -->
    <app-referral-modal
      *ngIf="showReferralModal"
      [patient]="patient"
      [isSubmitting]="isRequestingReferral"
      [createdBy]="createdBy"
      (closeModal)="onCloseModal()"
      (submitReferral)="onReferralSubmit($event)"
    ></app-referral-modal>

    <!-- Details Modal -->
    <div *ngIf="showReferralDetails && selectedReferral" class="referral-details-modal">
      <div class="modal-overlay" (click)="closeReferralDetails()"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h3>Referral Details - {{ selectedReferral.referralNumber }}</h3>
          <button type="button" class="close-btn" (click)="closeReferralDetails()">√ó</button>
        </div>
        <div class="modal-body">
          <div class="details-section">
            <h4>Referral To</h4>
            <div class="detail-row">
              <label>Hospital/Clinic:</label>
              <span>{{ selectedReferral.referredTo }}</span>
            </div>
            <div class="detail-row" *ngIf="selectedReferral.referredToAddress">
              <label>Address:</label>
              <span>{{ selectedReferral.referredToAddress }}</span>
            </div>
            <div class="detail-row" *ngIf="selectedReferral.referredToPhone">
              <label>Phone:</label>
              <span>{{ selectedReferral.referredToPhone }}</span>
            </div>
          </div>

          <div class="details-section">
            <h4>Clinical Information</h4>
            <div class="detail-row">
              <label>Clinical Findings:</label>
              <span>{{ selectedReferral.clinicalFindings || 'N/A' }}</span>
            </div>
            <div class="detail-row">
              <label>Diagnosis:</label>
              <span>{{ selectedReferral.diagnosis || 'N/A' }}</span>
            </div>
            <div class="detail-row">
              <label>Investigation Result:</label>
              <span>{{ selectedReferral.investigationResult || 'N/A' }}</span>
            </div>
            <div class="detail-row">
              <label>Rx Given:</label>
              <span>{{ selectedReferral.rxGiven || 'N/A' }}</span>
            </div>
            <div class="detail-row">
              <label>Reason for Referral:</label>
              <span>{{ selectedReferral.reasonForReferral }}</span>
            </div>
          </div>

          <div class="details-section">
            <h4>Status & Date</h4>
            <div class="detail-row">
              <label>Status:</label>
              <span [class]="getStatusClass(selectedReferral.status)">{{ selectedReferral.status }}</span>
            </div>
            <div class="detail-row">
              <label>Referral Date:</label>
              <span>{{ formatDate(selectedReferral.referralDate) }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>