<div class="prescription-card">
  <div class="dialog-title">
    <h2>{{ data.dialogTitle }}</h2>
    <button type="button" class="close-btn" (click)="dialogRef.close()">Close</button>
  </div>

  <div *ngIf="isLoading" class="loading">Loading prescription data...</div>

  <div *ngIf="errorMessage" class="error-message"
    [ngClass]="{'success-message': !isLoading && errorMessage.includes('successfully')}">
    {{ errorMessage }}
  </div>

  <form [formGroup]="prescriptionForm" (ngSubmit)="onSubmit()" *ngIf="!isLoading && !errorMessage">
    <div class="header">
      <div class="header-content">
        <div class="logo">
          <img [src]="logoPath" alt="Clinic Logo" class="logo-img" />
        </div>
        <div class="clinic-info">
          <h1>FEDERAL HOUSING CORPORATION MEDIUM CLINIC</h1>
          <div class="clinic-phone">TEL. 0118 553615</div>
        </div>
      </div>
    </div>

    <div class="title-section">
      <h2>Prescription Paper</h2>
    </div>

    <div class="form-actions">
      <!-- <div class="print-options" style="margin: 16px 0; text-align: center;">
        <button mat-raised-button color="primary" (click)="printPrescription('full')">
          Print Full Prescription (All Items)
        </button>
    
        <button mat-raised-button color="warn" (click)="printPrescription('out-of-stock')" 
                *ngIf="hasOutOfStockItems()">
          Print Out-of-Stock List Only
        </button>
      </div> -->
    
      <!-- Optional: keep your old buttons if you want fallback -->
      <!-- <button type="button" class="action-btn print-btn" (click)="printPrescription('full')">Print</button> -->
      <button type="button" class="action-btn pdf-btn" (click)="exportToPDF('full')">Export to PDF (Full)</button>
      <button type="button" class="action-btn pdf-btn" (click)="exportToPDF('out-of-stock')" 
              *ngIf="hasOutOfStockItems()">
        Export Out-of-Stock PDF
      </button>
    </div>

    <div class="patient-section">
      <div class="form-grid">
        <div class="form-row two-line-row">
          <div class="form-group">
            <label>Patient's Full Name:</label>
            <div class="input-container">
              <input type="text" class="underline-input form-control" formControlName="PatientName" readonly />
            </div>
          </div>
          <div class="form-group">
            <label>Town/Region:</label>
            <div class="input-container small">
              <input type="text" class="underline-input form-control" formControlName="woreda"
                [readonly]="!isEditing" />
            </div>
          </div>
          <div class="form-group">
            <label>Woreda:</label>
            <div class="input-container small">
              <input type="text" class="underline-input form-control" formControlName="woreda"
                [readonly]="!isEditing" />
            </div>
          </div>
          <div class="form-group">
            <label>Kebele/House No:</label>
            <div class="input-container small">
              <input type="text" class="underline-input form-control" formControlName="houseNo"
                [readonly]="!isEditing" />
            </div>
          </div>
          <div class="form-group">
            <label>Tel No:</label>
            <div class="input-container small">
              <input type="text" class="underline-input form-control" formControlName="phone" [readonly]="!isEditing" />
            </div>
          </div>
        </div>
        <div class="form-row two-line-row">
          <div class="form-group">
            <label>Sex:</label>
            <div class="input-container small">
              <input type="text" class="underline-input form-control" formControlName="gender" readonly />
            </div>
          </div>
          <div class="form-group">
            <label>Age:</label>
            <div class="input-container small">
              <input type="number" class="underline-input form-control" formControlName="age" readonly />
            </div>
          </div>
          <div class="form-group">
            <label>Weight:</label>
            <div class="input-container small">
              <input type="number" class="underline-input form-control" formControlName="Weight"
                [readonly]="!isEditing" />
            </div>
          </div>
          <div class="form-group">
            <label>Card No:</label>
            <div class="input-container small">
              <input type="text" class="underline-input form-control" formControlName="CardNumber" readonly />
            </div>
          </div>
        </div>
        <div class="form-group full-width">
          <label>Diagnosis:</label>
          <div class="input-container">
            <input type="text" class="underline-input form-control" formControlName="MedicalHistory" readonly />
          </div>
        </div>
      </div>
    </div>

    <!-- Updated medication-section in the HTML - Remove parsing and bind directly -->
    <div class="medication-section">
      <table class="medication-table">
        <thead>
          <tr>
            <th class="rx-header">Rx</th>
            <th class="med-name-header">Medicine name</th>
            <th class="strength-header">Strength</th>
            <th class="dosage-form-header">Dosage form</th>
            <th class="dose-header">Dose</th>
            <th class="frequency-header">Frequency</th>
            <th class="duration-header">Duration</th>
            <th class="quantity-header">Quantity</th>
            <th class="instructions-header">How to use and other information</th>
            <th class="price-header">Price (dispensers use only)</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let med of medications" class="medication-row">
            <td class="rx-cell">Rx</td>
            <td class="med-name-cell">{{ med.MedicationName || '' }}</td>
            <td class="strength-cell">{{ med.Strength || '' }}</td>
            <td class="dosage-form-cell">{{ med.DosageForm || '' }}</td>
            <td class="dose-cell">{{ med.Dose || '' }}</td>
            <td class="frequency-cell">{{ med.Frequency || '' }}</td>
            <td class="duration-cell">{{ med.Duration || '' }}</td>
            <td class="quantity-cell">{{ med.Quantity || '' }}</td>
            <td class="instructions-cell">{{ med.Instructions || '' }}</td>
            <td class="price-cell">{{ med.UnitPrice != null ? (med.UnitPrice * (med.Quantity || 1)) : '' }}</td>
          </tr>
          <tr *ngFor="let i of [].constructor(3 - medications.length)" class="medication-row">
            <td class="rx-cell"></td>
            <td class="med-name-cell"></td>
            <td class="strength-cell"></td>
            <td class="dosage-form-cell"></td>
            <td class="dose-cell"></td>
            <td class="frequency-cell"></td>
            <td class="duration-cell"></td>
            <td class="quantity-cell"></td>
            <td class="instructions-cell"></td>
            <td class="price-cell"></td>
          </tr>
          <tr class="total-row">
            <td colspan="9" class="total-label">Total price</td>
            <td class="total-price">
              {{ prescriptionForm.get('TotalAmount')?.value || calculateTotal() }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="info-section">
      <div class="info-column">
        <h3>Prescriber's</h3>
        <div class="info-fields">
          <div class="form-group">
            <label>Full Name:</label>
            <div class="input-container">
              <input type="text" class="underline-input form-control" formControlName="PrescriberName" readonly />
            </div>
          </div>
          <div class="form-group">
            <label>Qualification:</label>
            <div class="input-container">
              <input type="text" class="underline-input form-control" [value]="''" readonly />
            </div>
          </div>
          <div class="form-group">
            <label>Registration:</label>
            <div class="input-container">
              <input type="text" class="underline-input form-control" [value]="''" readonly />
            </div>
          </div>
          <div class="form-group">
            <label>Signature:</label>
            <div class="input-container">
              <input type="text" class="underline-input form-control" [value]="''" readonly />
            </div>
          </div>
          <div class="form-group">
            <label>Date:</label>
            <div class="input-container">
              <input type="date" class="underline-input form-control" formControlName="PrescriptionDate" readonly />
            </div>
          </div>
        </div>
      </div>
      <div class="info-column">
        <h3>Dispenser's</h3>
        <div class="info-fields">
          <div class="form-group">
            <label>Full Name:</label>
            <div class="input-container">
              <input type="text" class="underline-input form-control" formControlName="PharmacistName" readonly />
            </div>
          </div>
          <div class="form-group">
            <label>Qualification:</label>
            <div class="input-container">
              <input type="text" class="underline-input form-control" [value]="''" readonly />
            </div>
          </div>
          <div class="form-group">
            <label>Registration:</label>
            <div class="input-container">
              <input type="text" class="underline-input form-control" [value]="''" readonly />
            </div>
          </div>
          <div class="form-group">
            <label>Signature:</label>
            <div class="input-container">
              <input type="text" class="underline-input form-control" [value]="''" readonly />
            </div>
          </div>
          <div class="form-group">
            <label>Date:</label>
            <div class="input-container">
              <input type="date" class="underline-input form-control" formControlName="PrescriptionDate" readonly />
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>