<div class="reimbursement-upload-container">
  <div class="form-section">
    <h2>Reimbursement Document Upload</h2>
    
    <div class="user-info-card">
      <div class="user-info">
        <div class="info-item">
          <span class="label">Employee Name:</span>
          <span class="value">{{ employeeName || 'Loading...' }}</span>
        </div>
        <div class="info-item">
          <span class="label">Payroll Number:</span>
          <span class="value">{{ payrollNo || 'Loading...' }}</span> <!-- Changed to payrollNo -->
        </div>
        <div class="info-item">
          <span class="label">Department:</span>
          <span class="value">{{ departmentName || 'Loading...' }}</span> <!-- Added departmentName -->
        </div>
      </div>
    </div>

    <form [formGroup]="uploadForm" (ngSubmit)="onSubmit()" class="upload-form">
      <div class="form-group">
        <label for="formType">Form Type: <span class="required">*</span></label>
        <select id="formType" formControlName="formType" class="form-control">
          <option value="">Select a form type</option>
          <option *ngFor="let form of formTypes" [value]="form.value">
            {{ form.label }}
          </option>
        </select>
        <div class="error-message" *ngIf="uploadForm.get('formType')?.invalid && uploadForm.get('formType')?.touched">
          Form type is required
        </div>
      </div>

      <!-- Clinic Medical Expense Refund Fields -->
      <div *ngIf="uploadForm.get('formType')?.value === 'ClinicMedicalExpenseRefund'">
        <div class="form-group">
          <label for="patientName">Patient Name: <span class="required">*</span></label>
          <input
            type="text"
            id="patientName"
            formControlName="patientName"
            class="form-control"
            placeholder="Enter patient name"
            readonly>
          <div class="error-message" *ngIf="uploadForm.get('patientName')?.invalid && uploadForm.get('patientName')?.touched">
            Patient name is required
          </div>
        </div>

        <div class="form-group">
          <label for="payrollNo">Payroll Number: <span class="required">*</span></label>
          <input
            type="text"
            id="payrollNo"
            formControlName="payrollNo"
            class="form-control"
            placeholder="Enter payroll number"
            readonly>
          <div class="error-message" *ngIf="uploadForm.get('payrollNo')?.invalid && uploadForm.get('payrollNo')?.touched">
            Payroll number is required
          </div>
        </div>

        <div class="form-group">
          <label for="department">Department: <span class="required">*</span></label>
          <input
            type="text"
            id="department"
            formControlName="department"
            class="form-control"
            placeholder="Enter department"
            readonly>
          <div class="error-message" *ngIf="uploadForm.get('department')?.invalid && uploadForm.get('department')?.touched">
            Department is required
          </div>
        </div>

        <div class="form-group">
          <label for="doneAt">Done At: <span class="required">*</span></label>
          <input
            type="text"
            id="doneAt"
            formControlName="doneAt"
            class="form-control"
            placeholder="Enter location where investigation was done">
          <div class="error-message" *ngIf="uploadForm.get('doneAt')?.invalid && uploadForm.get('doneAt')?.touched">
            Done At is required
          </div>
        </div>

        <div class="form-group">
          <label for="orderedFrom">Ordered From: <span class="required">*</span></label>
          <input
            type="text"
            id="orderedFrom"
            formControlName="orderedFrom"
            class="form-control"
            placeholder="Enter where investigation was ordered from">
          <div class="error-message" *ngIf="uploadForm.get('orderedFrom')?.invalid && uploadForm.get('orderedFrom')?.touched">
            Ordered From is required
          </div>
        </div>

        <!-- Investigations Section -->
        <div class="investigation-section">
          <div class="section-header">
            <h3>Investigations</h3>
            <span class="total-amount">Total Amount: {{ totalAmount | currency:'ETB':'symbol':'1.2-2' }}</span>
          </div>
          
          <div *ngFor="let inv of investigations; let i = index" class="investigation-row">
            <div class="investigation-number">{{ i + 1 }}.</div>
            <div class="investigation-fields">
              <div class="form-group">
                <label>Investigation Type:</label>
                <input
                  type="text"
                  [(ngModel)]="inv.investigation"
                  [ngModelOptions]="{standalone: true}"
                  class="form-control"
                  placeholder="Enter investigation type">
              </div>
              <div class="form-group">
                <label>Invoice Number:</label>
                <input
                  type="text"
                  [(ngModel)]="inv.invoiceNumber"
                  [ngModelOptions]="{standalone: true}"
                  class="form-control"
                  placeholder="Enter invoice number">
              </div>
              <div class="form-group">
                <label>Amount (ETB):</label>
                <input
                  type="number"
                  [(ngModel)]="inv.amount"
                  [ngModelOptions]="{standalone: true}"
                  class="form-control"
                  placeholder="Enter amount"
                  min="0"
                  step="0.01">
              </div>
            </div>
            <button type="button" class="remove-btn" (click)="removeInvestigation(i)" 
                    [disabled]="investigations.length === 1" title="Remove Investigation">
              ×
            </button>
          </div>
          
          <button type="button" class="add-btn" (click)="addInvestigation()">
            + Add Another Investigation
          </button>
        </div>
      </div>

      <!-- Other Form Type Fields -->
      <div *ngIf="uploadForm.get('formType')?.value === 'Other'">
        <div class="form-group">
          <label for="description">Document Description: <span class="required">*</span></label>
          <input
            type="text"
            id="description"
            formControlName="description"
            class="form-control"
            placeholder="Enter description (e.g., Hospital Receipt, Medical Bill)">
          <div class="error-message" *ngIf="uploadForm.get('description')?.invalid && uploadForm.get('description')?.touched">
            Description is required
          </div>
        </div>

        <div class="form-group">
          <label for="files">Upload Files (Receipts/Documents): <span class="required">*</span></label>
          <input
            type="file"
            id="files"
            (change)="onFileChange($event)"
            multiple
            class="form-control"
            accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx">
          <div class="error-message" *ngIf="uploadForm.get('files')?.invalid && uploadForm.get('files')?.touched">
            At least one file is required
          </div>
          <div class="file-hint">Supported formats: PDF, Images, Word, Excel (Max 10MB per file)</div>
          
          <div *ngIf="selectedFiles.length > 0" class="file-list">
            <h4>Selected Files:</h4>
            <ul>
              <li *ngFor="let file of selectedFiles" class="file-item">
                <span class="file-name">{{ file.name }}</span>
                <span class="file-size">({{ formatFileSize(file.size) }})</span>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Auto-filled description for Clinic form -->
      <div *ngIf="uploadForm.get('formType')?.value === 'ClinicMedicalExpenseRefund'" class="form-info">
        <p>✓ Clinic Medical Expense Refund Form will be automatically generated and uploaded.</p>
        <p>✓ All investigations will be included in the reimbursement request.</p>
      </div>

      <div class="form-actions">
        <button
          type="submit"
          class="submit-btn"
          [disabled]="uploadForm.invalid || isSubmitting">
          <span *ngIf="!isSubmitting">Submit Reimbursement Request</span>
          <span *ngIf="isSubmitting" class="loading">
            <span class="spinner"></span>
            Processing...
          </span>
        </button>
        
        <button
          type="button"
          class="view-documents-btn"
          (click)="showDocuments()">
          View My Documents
        </button>
      </div>
    </form>
  </div>

  <!-- Enhanced Uploaded Documents Modal -->
  <div class="modal" *ngIf="showDocumentsModal">
    <div class="modal-backdrop" (click)="closeDocuments()"></div>
    <div class="modal-content large-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>My Reimbursement Documents</h3>
        <button type="button" class="close-btn" (click)="closeDocuments()" title="Close">&times;</button>
      </div>
      
      <div class="modal-body">
        <!-- Reimbursement Selection -->
        <div class="section" *ngIf="reimbursements.length > 0">
          <h4>Select Reimbursement Request</h4>
          <div class="form-group">
            <select class="form-control" (change)="loadDocumentsForReimbursement($event)" [value]="selectedReimbursementId || ''">
              <option value="">-- Choose a reimbursement request --</option>
              <option *ngFor="let reimb of reimbursements" [value]="reimb.reimbursementID">
                {{ reimb.reimbursementNumber }} - 
                {{ reimb.patientName }} - 
                {{ reimb.totalAmount | currency:'ETB':'symbol':'1.2-2' }} - 
                <span [class]="'status-' + reimb.status.toLowerCase()">{{ reimb.status | titlecase }}</span>
              </option>
            </select>
          </div>
        </div>

        <!-- Documents Grid -->
        <div class="section" *ngIf="uploadedDocuments.length > 0">
          <h4>Uploaded Documents ({{ uploadedDocuments.length }})</h4>
          <div class="documents-grid">
            <div *ngFor="let doc of uploadedDocuments" class="document-card" (click)="$event.stopPropagation()">
              <div class="document-header">
                <h5>{{ doc.description || 'Document' }}</h5>
                <div class="document-actions">
                  <button type="button" class="download-btn" (click)="downloadDocument(doc)" title="Download">
                    <span class="download-icon">↓</span> Download
                  </button>
                </div>
              </div>
              
              <div class="document-details">
                <div class="detail-item">
                  <strong>File Name:</strong> {{ doc.fileName }}
                </div>
                <div class="detail-item">
                  <strong>File Type:</strong> {{ doc.fileType }}
                </div>
                <div class="detail-item">
                  <strong>File Size:</strong> {{ formatFileSize(doc.fileSize) }}
                </div>
                <div class="detail-item">
                  <strong>Upload Date:</strong> {{ doc.uploadDate | date:'medium' }}
                </div>
                <div class="detail-item">
                  <strong>Uploaded By:</strong> {{ doc.uploadedBy }}
                </div>
              </div>
              
              <!-- Document Preview -->
              <div *ngIf="getPreviewType(doc.fileType, doc.fileName) !== 'none'" class="preview-section">
                <div class="preview-header">
                  <span>Document Preview</span>
                  <button type="button" class="download-btn small" (click)="downloadDocument(doc)" title="Download Full Document">
                    <span class="download-icon">↓</span> Download
                  </button>
                </div>
                
                <div class="preview-content">
                  <!-- PDF Preview -->
                  <ng-container *ngIf="getPreviewType(doc.fileType, doc.fileName) === 'pdf'">
                    <div class="preview-frame">
                      <ng-container *ngIf="pdfLoading[doc.documentID]">
                        <div class="preview-loading">
                          <span class="spinner"></span>
                          Loading PDF...
                        </div>
                      </ng-container>
                      <ng-container *ngIf="!pdfLoading[doc.documentID] && pdfLoadErrors[doc.documentID]; else pdfEmbed">
                        <div class="preview-error">
                          <p>⚠️ {{ pdfLoadErrors[doc.documentID] }}</p>
                          <div class="error-actions">
                            <button type="button" class="retry-btn" 
                                    (click)="retryPdfLoad(doc)"
                                    [disabled]="(pdfRetryCount[doc.documentID] || 0) >= 3">
                              <span class="retry-icon">🔄</span> 
                              Retry {{ (pdfRetryCount[doc.documentID] || 0) > 0 ? '(' + (pdfRetryCount[doc.documentID] || 0) + '/3)' : '' }}
                            </button>
                            <button type="button" class="download-btn" (click)="downloadDocument(doc)">
                              <span class="download-icon">↓</span> Download Instead
                            </button>
                          </div>
                        </div>
                      </ng-container>
                      <ng-template #pdfEmbed>
                        <embed [src]="getPdfPreviewUrl(doc)"
                               type="application/pdf" 
                               width="100%" 
                               height="400px"
                               (load)="onPdfLoad(doc)"
                               (error)="onPdfError(doc, $event)" />
                      </ng-template>
                    </div>
                  </ng-container>
                  
                  <!-- Image Preview -->
                  <ng-container *ngIf="getPreviewType(doc.fileType, doc.fileName) === 'image'">
                    <div class="preview-frame">
                      <img [src]="getDocumentPreviewUrl(doc)" 
                           [alt]="doc.description" 
                           class="preview-image"
                           (load)="onImageLoad($event)"
                           (error)="onImageError($event)" />
                    </div>
                  </ng-container>
                  
                  <!-- Office Document Preview -->
                  <ng-container *ngIf="getPreviewType(doc.fileType, doc.fileName) === 'office'">
                    <div class="preview-frame">
                      <iframe [src]="getOfficePreviewUrl(doc)" 
                              width="100%" 
                              height="400px" 
                              frameborder="0"
                              title="Office Document Preview"></iframe>
                    </div>
                  </ng-container>
                </div>
              </div>

              <div *ngIf="getPreviewType(doc.fileType, doc.fileName) === 'none'" class="no-preview">
                <p>Preview not available for this file type.</p>
                <button type="button" class="download-btn" (click)="downloadDocument(doc)">
                  <span class="download-icon">↓</span> Download File
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Empty States -->
        <div *ngIf="uploadedDocuments.length === 0 && selectedReimbursementId" class="empty-state">
          <div class="empty-icon">📄</div>
          <h4>No Documents Found</h4>
          <p>No documents have been uploaded for this reimbursement request yet.</p>
        </div>

        <div *ngIf="reimbursements.length === 0" class="empty-state">
          <div class="empty-icon">📋</div>
          <h4>No Reimbursement Requests</h4>
          <p>You haven't created any reimbursement requests yet.</p>
          <p>Submit your first reimbursement request using the form above.</p>
        </div>

        <div *ngIf="!selectedReimbursementId && reimbursements.length > 0" class="empty-state">
          <div class="empty-icon">🔍</div>
          <h4>Select a Reimbursement</h4>
          <p>Please select a reimbursement request from the dropdown above to view its documents.</p>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="action-btn cancel" (click)="closeDocuments()">Close</button>
      </div>
    </div>
  </div>

  <!-- Hidden PDF Template -->
  <div #pdfTemplate id="pdf-template" class="pdf-template">
    <div class="page">
      <div class="header-top">
        <div class="logo">
          <img src="https://efhc.gov.et/xokaerp/datepicker/img/fhc_log.jpg" alt="FHC Logo" />
        </div>

        <div class="title-block">
          <div class="company">Federal Housing Corporation</div>
          <div class="form-title">Clinic Medical Expense Refund Form</div>
        </div>

        <div class="no-date">
          <div><span class="label">No.</span><span class="line"></span></div>
          <div style="margin-top:8px;"><span class="label">Date</span><span class="line" style="width:180px;"></span></div>
        </div>
      </div>

      <div class="form-body">
        <div class="row">
          <div class="label">1. Name of patient</div>
          <div class="fill">{{ uploadForm.get('patientName')?.value || '' }}</div>
        </div>

        <div class="row">
          <div class="label">2. Payroll no</div>
          <div class="short-fill">{{ uploadForm.get('payrollNo')?.value || '' }}</div>
        </div>

        <div class="row">
          <div class="label">3. Department</div>
          <div class="short-fill">{{ uploadForm.get('department')?.value || '' }}</div>
        </div>

        <div class="row" style="margin-top:6px;">
          <div style="width:100%;">4. <span style="font-weight:600">Investigation</span></div>
        </div>

        <div class="investigation">
          <div class="left">
            <span class="small-label">Done at</span>
            <span class="short-fill" style="width:260px;">{{ uploadForm.get('doneAt')?.value || '' }}</span>
          </div>
          <div class="right">
            <span class="small-label">Ordered from</span>
            <span class="short-fill" style="width:260px;">{{ uploadForm.get('orderedFrom')?.value || '' }}</span>
          </div>
        </div>

        <div style="font-style:italic; margin-bottom:6px;">As per invoice attached (number of invoice)</div>

        <div class="items">
          <div *ngFor="let inv of investigations; let i = index" class="line-item">
            <div class="number">{{i+1}}.</div>
            <div class="blank">{{ inv.investigation }} (Invoice: {{ inv.invoiceNumber }}, Amount: {{ inv.amount }})</div>
          </div>
          <ng-container *ngFor="let dummy of [].constructor(20 - investigations.length); let j = index">
            <div class="line-item">
              <div class="number">{{investigations.length + j + 1}}.</div>
              <div class="blank"></div>
            </div>
          </ng-container>
        </div>

        <div class="footer-note">The medical expense should be paid to the patient</div>

        <div class="sign-block">
          <div class="stamp">
            <div class="sign-line" style="width:70%;">Stamp</div>
          </div>
          <div class="sig">
            <div class="sign-line" style="width:80%;">sig of head of clinic</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>