<div class="patient-card-container">
  <h2>Patient Card Management</h2>
  <!-- Search Form -->
  <div class="search-container">
    <form [formGroup]="searchForm" (ngSubmit)="onSearch()" class="search-form">
      <div class="form-group">
        <label for="patientID">Patient ID:</label>
        <input type="text" id="patientID" formControlName="patientID" class="form-control"
          placeholder="Enter patient ID">
        <div class="error-message" *ngIf="searchForm.get('patientID')?.invalid && searchForm.get('patientID')?.touched">
          Patient ID is required
        </div>
      </div>
      <button type="submit" class="search-btn" [disabled]="searchForm.invalid || isSearching">
        {{ isSearching ? 'Searching...' : 'Search Patient' }}
      </button>
    </form>
  </div>

  <div class="active-patients-section" *ngIf="!isSearchMode && activePatients.length > 0">
    <h3>Active Patients</h3>
    <div class="table-container">
      <table class="active-patients-table">
        <thead>
          <tr>
            <th>Patient ID</th>
            <th>Card Number</th>
            <th>Full Name</th>
            <th>Age</th>
            <th>Gender</th>
            <th>Last Visit</th>
            <th>Registration Date</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let patient of activePatients" (click)="onPatientRowClick(patient)" class="clickable-row">
            <td>{{ patient.PatientID }}</td>
            <td>{{ patient.CardNumber }}</td>
            <td>{{ patient.FullName }}</td>
            <td>{{ patient.Age }}</td>
            <td>{{ patient.gender }}</td>
            <td>{{ patient.LastVisitDate | date:'medium' }}</td>
            <td>{{ patient.RegistrationDate | date:'medium' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- No Active Patients Message -->
  <div class="no-results" *ngIf="!isSearchMode && !searched && activePatients.length === 0 && !isSearching">
    No active patients found.
  </div>

  <!-- Tabs Navigation -->
  <div class="tabs-container" *ngIf="patient">
    <div class="tabs">
      <button type="button" class="tab-button" [class.active]="selectedTab === 'patient-info'"
        (click)="selectTab('patient-info')">
        Patient Information
      </button>
      <button type="button" class="tab-button" [class.active]="selectedTab === 'laboratory-tests'"
        (click)="selectTab('laboratory-tests')">
        Laboratory
      </button>
      <button type="button" class="tab-button" [class.active]="selectedTab === 'prescriptions'" [class.disabled]="hasPendingLabs"
        (click)="selectTab('prescriptions')">
        Pharmacy
      </button>
      <button type="button" class="tab-button" [class.active]="selectedTab === 'referrals'"
        (click)="selectTab('referrals')">
        Referrals
      </button>
      <button type="button" class="tab-button" [class.active]="selectedTab === 'injections'"
        (click)="selectTab('injections')">
        ðŸ’‰ Procedure Room
      </button>
      <!-- <button 
        class="tab-button" 
        [class.active]="selectedTab === 'patient-assignment'"
        (click)="selectTab('patient-assignment')">
        Room Assignment
      </button> -->
      <button type="button" class="tab-button" [class.active]="selectedTab === 'sick-leave'"
        (click)="selectTab('sick-leave')">
        Sick Leave
      </button>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
      <!-- Patient Information Tab -->
      <div *ngIf="selectedTab === 'patient-info'">
        <!-- Patient Card Display -->
        <app-patient-card [patient]="patient" [showEditButton]="true" (editClick)="onEditClick()">
        </app-patient-card>

        <!-- Edit Form -->
        <div class="edit-form">
          <h3>Edit Patient Information</h3>
          <form [formGroup]="editForm" (ngSubmit)="onEditSubmit()" class="patient-form">
            <!-- Existing Fields -->
            <div class="form-group">
              <label for="allergies">Allergies:</label>
              <textarea id="allergies" formControlName="allergies" class="form-control" rows="4"></textarea>
            </div>
            <!-- Medical History Toggleable Panel -->
            <div class="medical-history-panel">
              <h4>Medical History Records</h4>
              <div class="history-item" *ngFor="let history of medicalHistories; let i = index">
                <div class="history-header" (click)="toggleHistory(i)">
                  <span>{{ history.CreatedDate | date:'medium' }}</span>
                  <span class="toggle-icon">{{ showHistoryIndex === i ? 'â–¼' : 'â–¶' }}</span>
                </div>
                <div class="history-content" *ngIf="showHistoryIndex === i">
                  <p>{{ history.MedicalHistory || 'No medical history recorded' }}</p>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="medicalHistory">Medical History</label>
              <textarea id="medicalHistory" formControlName="medicalHistory" class="form-control" rows="4"></textarea>
            </div>
            <div class="form-group">
              <label for="lastDiagnosis">Diagnosis:</label>
              <input type="text" id="lastDiagnosis" formControlName="lastDiagnosis" class="form-control">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="registrationDate">Registration Date:</label>
                <input type="date" id="registrationDate" formControlName="RegistrationDate" class="form-control"
                  [readonly]="true">
              </div>
              <div class="form-group">
                <label for="bloodType">Blood Type:</label>
                <input type="text" id="bloodType" formControlName="bloodType" class="form-control"
                  [readonly]="patient?.bloodType">
                <div class="error-message"
                  *ngIf="editForm.get('bloodType')?.invalid && editForm.get('bloodType')?.touched">
                  Blood Type is required
                </div>
              </div>
            </div>
            <!-- New Fields -->
            <div class="form-row">
              <div class="form-group">
                <label for="weight">Weight (kg):</label>
                <input type="number" id="weight" formControlName="weight" class="form-control" step="0.1"
                  placeholder="Enter weight in kg">
                <div class="error-message" *ngIf="editForm.get('weight')?.invalid && editForm.get('weight')?.touched">
                  Valid weight is required
                </div>
              </div>
              <div class="form-group">
                <label for="height">Height (cm):</label>
                <input type="number" id="height" formControlName="height" class="form-control" step="0.1"
                  placeholder="Enter height in cm">
                <div class="error-message" *ngIf="editForm.get('height')?.invalid && editForm.get('height')?.touched">
                  Valid height is required
                </div>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="bloodPressure">Blood Pressure (mmHg):</label>
                <input type="text" id="bloodPressure" formControlName="bloodPressure" class="form-control"
                  placeholder="e.g., 120/80">
                <div class="error-message"
                  *ngIf="editForm.get('bloodPressure')?.invalid && editForm.get('bloodPressure')?.touched">
                  Valid blood pressure is required
                </div>
              </div>
              <div class="form-group">
                <label for="pulseRate">Pulse Rate (bpm):</label>
                <input type="text" id="pulseRate" formControlName="pulseRate" class="form-control"
                  placeholder="Enter pulse rate">
                <div class="error-message"
                  *ngIf="editForm.get('pulseRate')?.invalid && editForm.get('pulseRate')?.touched">
                  Valid pulse rate is required
                </div>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="temperature">Temperature (Â°C):</label>
                <input type="number" id="temperature" formControlName="temperature" class="form-control" step="0.1"
                  placeholder="Enter temperature">
                <div class="error-message"
                  *ngIf="editForm.get('temperature')?.invalid && editForm.get('temperature')?.touched">
                  Valid temperature is required
                </div>
              </div>
              <div class="form-group">
                <label for="bmi">BMI:</label>
                <input type="text" id="bmi" formControlName="bmi" class="form-control" placeholder="Enter BMI"
                  [readonly]="true">
              </div>
            </div>
            <div class="form-group">
              <label for="chiefComplaint">Chief Complaint:</label>
              <textarea id="chiefComplaint" formControlName="chiefComplaint" class="form-control" rows="4"
                placeholder="Enter chief complaint"></textarea>
              <div class="error-message"
                *ngIf="editForm.get('chiefComplaint')?.invalid && editForm.get('chiefComplaint')?.touched">
                Chief complaint is required
              </div>
            </div>
            <div class="form-group">
              <label for="treatmentPlan">Treatment Plan:</label>
              <textarea id="treatmentPlan" formControlName="treatmentPlan" class="form-control" rows="4"
                placeholder="Enter treatment plan"></textarea>
            </div>
            <div class="form-group">
              <label for="nextAppointment">Next Appointment:</label>
              <input type="date" id="nextAppointment" formControlName="nextAppointment" class="form-control">
            </div>
            <button type="submit" class="submit-btn" [disabled]="isEditing">
              {{ isEditing ? 'Updating...' : 'Update Patient' }}
            </button>
          </form>
        </div>
      </div>

      <!-- Laboratory Tests Tab -->
      <div *ngIf="selectedTab === 'laboratory-tests'">
        <!-- Laboratory Test Request Form -->
        <div class="lab-request-form">
          <h3>Request Laboratory Test</h3>
          <form [formGroup]="labRequestForm" (ngSubmit)="onLabRequestSubmit()" class="lab-form">
            <div class="form-row">
              <div class="form-group">
                <label for="testNumber">Test Number:</label>
                <input type="text" id="testNumber" formControlName="testNumber" class="form-control"
                  placeholder="Auto-generated test number">
                <div class="error-message"
                  *ngIf="labRequestForm.get('testNumber')?.invalid && labRequestForm.get('testNumber')?.touched">
                  Test number is required
                </div>
              </div>
              <div class="form-group">
                <label for="testCategory">Test Category:</label>
                <select id="testCategory" formControlName="testCategory" class="form-control">
                  <option value="Chemistry">Chemistry</option>
                  <option value="Bacteriology">Bacteriology</option>
                  <option value="Fluid_Analysis">Fluid Analysis</option>
                  <option value="Hematology">Hematology</option>
                  <option value="Serology">Serology</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="priority">Priority:</label>
                <select id="priority" formControlName="priority" class="form-control">
                  <option value="Normal">Normal</option>
                  <option value="Urgent">Urgent</option>
                  <option value="STAT">STAT</option>
                </select>
              </div>
              <div class="form-group">
                <label for="clinicalNotes">Clinical Notes:</label>
                <textarea id="clinicalNotes" formControlName="clinicalNotes" class="form-control" rows="4"></textarea>
              </div>
            </div>
            <div class="tests-section">
              <h4>Test Details</h4>
              <div *ngIf="filteredTests && filteredTests.length > 0" class="test-checkboxes">
                <label *ngFor="let test of filteredTests; let idx = index">
                  <input type="checkbox" [checked]="isTestSelected(test.name)"
                    (change)="onTestCheckboxChange($event, test)" />
                  {{ test.name }}
                </label>
              </div>
              <div formArrayName="tests">
                <div *ngFor="let test of testsFormArray.controls; let i = index" [formGroupName]="i" class="test-item">
                  <div class="form-group">
                    <label>Test Name:</label>
                    <input type="text" formControlName="testName" class="form-control" readonly />
                  </div>
                  <div class="form-group">
                    <label>Normal Range:</label>
                    <input type="text" formControlName="normalRange" class="form-control" readonly />
                  </div>
                  <button type="button" class="action-btn remove" (click)="removeTest(i)">Remove</button>
                </div>
              </div>
            </div>
            <button type="submit" class="submit-btn" [disabled]="labRequestForm.invalid || isRequestingLab">
              {{ isRequestingLab ? 'Requesting...' : 'Request Laboratory Test' }}
            </button>
          </form>
        </div>

        <!-- Laboratory Tests List -->
        <div class="tests-list">
          <h3>Patient Laboratory Tests</h3>
          <div class="table-container">
            <table class="tests-table">
              <thead>
                <tr>
                  <th>Test Number</th>
                  <th>Test Category</th>
                  <th>Test Date</th>
                  <th>Priority</th>
                  <th>Status</th>
                  <th>Physician</th>
                  <!-- <th>Technician</th> -->
                  <th>Reported By</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let test of laboratoryTests">
                  <td>{{ test.testNumber }}</td>
                  <td>{{ test.testCategory }}</td>
                  <td>{{ test.testDate | date:'short' }}</td>
                  <td>{{ test.priority }}</td>
                  <td>{{ test.status }}</td>
                  <td>{{ test.orderingPhysicianName }}</td>
                  <!-- <td>{{ test.technicianName || 'N/A' }}</td> -->
                  <td>{{ test.reportedByName || 'N/A' }}</td>
                  <td>
                    <button type="button" class="action-btn view" (click)="viewTestDetails(test.testID)">View
                      Results</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Laboratory Report Dialog - Replace the inline dialog with this -->
        <app-laboratory-report-dialog [showDialog]="showTestDetailsDialog" [testNumber]="selectedTestNumber"
          [testData]="selectedTestData" [testDetails]="selectedTestDetails" (close)="closeTestDetailsDialog()">
        </app-laboratory-report-dialog>
      </div>

      <!-- Prescriptions Tab -->
      <div *ngIf="selectedTab === 'prescriptions'">
        <!-- Prescription Request Form -->
        <div class="prescription-request-form">
          <h3>Request Prescription</h3>
          <form [formGroup]="prescriptionForm" (ngSubmit)="onPrescriptionSubmit()" class="prescription-form">
            <div class="form-row">
              <div class="form-group">
                <label for="prescriptionNumber">Prescription Number:</label>
                <input type="text" id="prescriptionNumber" formControlName="prescriptionNumber" class="form-control"
                  placeholder="Auto-generated prescription number" [disabled]="true">
                <div class="error-message"
                  *ngIf="prescriptionForm.get('prescriptionNumber')?.invalid && prescriptionForm.get('prescriptionNumber')?.touched">
                  Prescription number is required
                </div>
              </div>
              <div class="form-group">
                <label for="notes">Notes:</label>
                <textarea id="notes" formControlName="notes" class="form-control" rows="4"></textarea>
              </div>
            </div>
            <div class="medications-section">
              <h4>Medications</h4>
              <div formArrayName="medications">
                <div *ngFor="let medication of medicationsFormArray.controls; let i = index" [formGroupName]="i"
                  class="medication-item">
                  <div class="form-row">
                    <div class="form-group">
                      <label for="medicationID-{{i}}">Medication:</label>
                      <app-medication-tree-dropdown [medications]="categorizedMedications"
                        [placeholder]="'Select medication'" [formControlName]="'medicationID'"
                        (selectionChange)="onMedicationSelection($event, i)"
                        [error]="medication.get('medicationID')?.invalid && medication.get('medicationID')?.touched ? 'Medication is required' : ''">
                      </app-medication-tree-dropdown>
                      <div class="error-message"
                        *ngIf="medication.get('medicationID')?.invalid && medication.get('medicationID')?.touched">
                      </div>
                    </div>
                    <div class="form-group">
                      <label for="dose-{{i}}">Dose:</label>
                      <input type="text" id="dose-{{i}}" formControlName="dose" class="form-control"
                        placeholder="e.g., 1 tablet">
                      <div class="error-message"
                        *ngIf="medication.get('dose')?.invalid && medication.get('dose')?.touched">
                        Dose is required
                      </div>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="frequency-{{i}}">Frequency:</label>
                      <select id="frequency-{{i}}" formControlName="frequency" class="form-control">
                        <option value="">Select frequency</option>
                        <option value="Once daily">Once daily</option>
                        <option value="Twice daily">Twice daily</option>
                        <option value="Three times daily">Three times daily</option>
                        <option value="Four times daily">Four times daily</option>
                        <option value="As needed">As needed</option>
                      </select>
                      <div class="error-message"
                        *ngIf="medication.get('frequency')?.invalid && medication.get('frequency')?.touched">
                        Frequency is required
                      </div>
                    </div>
                    <div class="form-group">
                      <label for="duration-{{i}}">Duration:</label>
                      <input type="text" id="duration-{{i}}" formControlName="duration" class="form-control"
                        placeholder="e.g., 7 days">
                      <div class="error-message"
                        *ngIf="medication.get('duration')?.invalid && medication.get('duration')?.touched">
                        Duration is required
                      </div>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="quantity-{{i}}">Quantity:</label>
                      <input type="number" id="quantity-{{i}}" formControlName="quantity" class="form-control"
                        placeholder="Enter quantity">
                      <div class="error-message"
                        *ngIf="medication.get('quantity')?.invalid && medication.get('quantity')?.touched">
                        Valid quantity is required
                      </div>
                    </div>
                    <!-- <div class="form-group">
                <label for="unitPrice-{{i}}">Unit Price (ETB):</label>
                <input 
                  type="number" 
                  step="0.01" 
                  id="unitPrice-{{i}}" 
                  formControlName="unitPrice"
                  class="form-control"
                  placeholder="Enter unit price">
                <div class="error-message" *ngIf="medication.get('unitPrice')?.invalid && medication.get('unitPrice')?.touched">
                  Valid unit price is required
                </div>
              </div> -->
                  </div>
                  <div class="form-group">
                    <label for="instructions-{{i}}">Instructions:</label>
                    <textarea id="instructions-{{i}}" formControlName="instructions" class="form-control" rows="2"
                      placeholder="How to use and other information"></textarea>
                  </div>
                  <button type="button" class="action-btn remove" (click)="removeMedication(i)">Remove</button>
                </div>
              </div>
              <button type="button" class="action-btn add" (click)="addMedication()">Add Medication</button>
            </div>
            <button type="submit" class="submit-btn" [disabled]="prescriptionForm.invalid || isRequestingPrescription">
              {{ isRequestingPrescription ? 'Requesting...' : 'Request Prescription' }}
            </button>
          </form>
        </div>

        <!-- Prescriptions List -->
        <div class="prescriptions-list">
          <h3>Patient Prescriptions</h3>
          <div class="table-container">
            <table class="prescriptions-table">
              <thead>
                <tr>
                  <th>Prescription Number</th>
                  <th>Prescription Date</th>
                  <th>Total Amount</th>
                  <th>Status</th>
                  <th>Prescriber</th>
                  <th>Pharmacist</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let prescription of prescriptions">
                  <td>{{ prescription.prescriptionNumber }}</td>
                  <td>{{ prescription.prescriptionDate | date:'short' }}</td>
                  <td>{{ prescription.totalAmount | currency:'ETB':'symbol':'1.2-2' }}</td>
                  <td>{{ prescription.status }}</td>
                  <td>{{ prescription.prescriberName }}</td>
                  <td>{{ prescription.pharmacistName || 'N/A' }}</td>
                  <td>
                    <button type="button" class="action-btn view"
                      (click)="viewPrescriptionDetails(prescription.prescriptionID)">View Details</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Prescription Paper Component - Replace the inline dialog with this -->
          <app-prescription-paper *ngIf="showPrescriptionDetailsDialog" [cardNumber]="selectedCardNumber"
            (close)="closePrescriptionDetailsDialog()">
          </app-prescription-paper>
        </div>
       
        <div class="prescription-details-dialog" *ngIf="showPrescriptionDetailsDialog">
          <div class="dialog-backdrop" (click)="closePrescriptionDetailsDialog()"></div>
          <div class="dialog-content">
            <!-- <h3>Prescription Details for #{{ selectedPrescriptionNumber }}</h3> -->
            <!-- <app-prescription-paper [prescriptionData]="selectedPrescriptionDetails[0]"></app-prescription-paper> -->
            <app-prescription-paper [cardNumber]="cardNumber"></app-prescription-paper>

            <button type="button" class="close-btn" (click)="closePrescriptionDetailsDialog()">Close</button>
          </div>
        </div>
      </div>

      <!-- Injections Tab -->
      <div *ngIf="selectedTab === 'injections'">
        <!-- Procedure Type Selection -->
        <div class="procedure-type-selection">
          <h3>ðŸ’‰ Procedure Room Request</h3>
          <div class="procedure-type-tabs">
            <button type="button" class="procedure-type-btn" 
                [class.active]="selectedProcedureType === 'injection'"
                (click)="selectProcedureType('injection')">
                ðŸ’‰ Injection
            </button>
            <button type="button" class="procedure-type-btn" 
                [class.active]="selectedProcedureType === 'wound-care'"
                (click)="selectProcedureType('wound-care')">
                ðŸ©¹ Wound Care
            </button>
            <button type="button" class="procedure-type-btn" 
                [class.active]="selectedProcedureType === 'suturing'"
                (click)="selectProcedureType('suturing')">
                ðŸª¡ Suturing
            </button>
            <button type="button" class="procedure-type-btn" 
                [class.active]="selectedProcedureType === 'ear-irrigation'"
                (click)="selectProcedureType('ear-irrigation')">
                ðŸ‘‚ Ear Irrigation
            </button>
          </div>
        </div>

        <!-- Injection Form -->
        <div *ngIf="selectedProcedureType === 'injection'" class="injection-request-form">
          <h3>ðŸ’‰ Request Injection</h3>
          <form [formGroup]="injectionForm" (ngSubmit)="onInjectionSubmit()" class="injection-form">
            <div class="form-row">
              <div class="form-group">
                <label for="injectionNumber">Injection Number:</label>
                <input type="text" id="injectionNumber" formControlName="injectionNumber" class="form-control"
                  [readonly]="true" placeholder="Auto-generated injection number">
                <div class="error-message"
                  *ngIf="injectionForm.get('injectionNumber')?.invalid && injectionForm.get('injectionNumber')?.touched">
                  Injection number is required
                </div>
              </div>
              <div class="form-group">
                <label for="medicationID">Medication:</label>
                <app-medication-tree-dropdown [medications]="categorizedInjectableMedications"
                  [placeholder]="'Select injectable medication'" formControlName="medicationID"
                  (selectionChange)="onInjectionMedicationSelection($event)"
                  [error]="injectionForm.get('medicationID')?.invalid && injectionForm.get('medicationID')?.touched ? 'Medication is required' : ''">
                </app-medication-tree-dropdown>
                <div class="error-message"
                  *ngIf="injectionForm.get('medicationID')?.invalid && injectionForm.get('medicationID')?.touched">
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="dose">Dose:</label>
                <input type="text" id="dose" formControlName="dose" class="form-control" placeholder="e.g., 2 mL">
                <div class="error-message"
                  *ngIf="injectionForm.get('dose')?.invalid && injectionForm.get('dose')?.touched">
                  Dose is required
                </div>
              </div>
              <div class="form-group">
                <label for="route">Route:</label>
                <select id="route" formControlName="route" class="form-control">
                  <option value="">Select route</option>
                  <option value="IV">Intravenous (IV)</option>
                  <option value="IM">Intramuscular (IM)</option>
                  <option value="SC">Subcutaneous (SC)</option>
                  <option value="ID">Intradermal (ID)</option>
                </select>
                <div class="error-message"
                  *ngIf="injectionForm.get('route')?.invalid && injectionForm.get('route')?.touched">
                  Route is required
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="site">Site:</label>
                <input type="text" id="site" formControlName="site" class="form-control" placeholder="e.g., Left arm">
                <div class="error-message"
                  *ngIf="injectionForm.get('site')?.invalid && injectionForm.get('site')?.touched">
                  Site is required
                </div>
              </div>
              <div class="form-group">
                <label for="frequency">Frequency:</label>
                <select id="frequency" formControlName="frequency" class="form-control">
                  <option value="">Select frequency</option>
                  <option value="Once">Once</option>
                  <option value="Daily">Daily</option>
                  <option value="Every 12 hours">Every 12 hours</option>
                  <option value="Every 8 hours">Every 8 hours</option>
                  <option value="Every 6 hours">Every 6 hours</option>
                </select>
                <div class="error-message"
                  *ngIf="injectionForm.get('frequency')?.invalid && injectionForm.get('frequency')?.touched">
                  Frequency is required
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="duration">Duration:</label>
                <input type="text" id="duration" formControlName="duration" class="form-control"
                  placeholder="e.g., 5 days">
                <div class="error-message"
                  *ngIf="injectionForm.get('duration')?.invalid && injectionForm.get('duration')?.touched">
                  Duration is required
                </div>
              </div>
              <div class="form-group">
                <label for="totalDoses">Total Doses:</label>
                <input type="number" id="totalDoses" formControlName="totalDoses" class="form-control" min="1"
                  placeholder="Total number of doses">
                <div class="error-message"
                  *ngIf="injectionForm.get('totalDoses')?.invalid && injectionForm.get('totalDoses')?.touched">
                  Total doses is required (minimum 1)
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="startDate">Start Date:</label>
                <app-ethiopian-date-picker formControlName="startDate" placeholder="Select start date"></app-ethiopian-date-picker>
              </div>
              <div class="form-group">
                <label for="startTime">Start Time:</label>
                <input type="time" id="startTime" formControlName="startTime" class="form-control">
              </div>
              <div class="form-group checkbox-group">
                <label for="isRecurring" class="checkbox-label">
                  <input type="checkbox" id="isRecurring" formControlName="isRecurring">
                  Recurring Injection
                </label>
              </div>
            </div>

            <div class="form-group">
              <label for="instructions">Instructions:</label>
              <textarea id="instructions" formControlName="instructions" class="form-control" rows="2"
                placeholder="Additional administration instructions"></textarea>
            </div>

            <div class="form-group">
              <label for="notes">Notes:</label>
              <textarea id="notes" formControlName="notes" class="form-control" rows="4"></textarea>
            </div>

            <button type="submit" class="submit-btn" [disabled]="injectionForm.invalid || isRequestingInjection">
              {{ isRequestingInjection ? 'Requesting...' : 'Request Injection' }}
            </button>
          </form>
        </div>

        <!-- Wound Care Form -->
        <div *ngIf="selectedProcedureType === 'wound-care'" class="wound-care-request-form">
          <h3>ðŸ©¹ Request Wound Care</h3>
          <form [formGroup]="woundCareForm" (ngSubmit)="onWoundCareSubmit()" class="wound-care-form">
            <div class="form-row">
              <div class="form-group">
                <label for="woundCareNumber">Wound Care Number:</label>
                <input type="text" id="woundCareNumber" formControlName="woundCareNumber" class="form-control"
                  [readonly]="true" placeholder="Auto-generated wound care number">
              </div>
              <div class="form-group">
                <label for="woundType">Wound Type:</label>
                <select id="woundType" formControlName="woundType" class="form-control">
                  <option value="">Select wound type</option>
                  <option value="Laceration">Laceration</option>
                  <option value="Abrasion">Abrasion</option>
                  <option value="Puncture">Puncture</option>
                  <option value="Burn">Burn</option>
                  <option value="Ulcer">Ulcer</option>
                  <option value="Surgical">Surgical</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="woundLocation">Wound Location:</label>
                <input type="text" id="woundLocation" formControlName="woundLocation" class="form-control" 
                  placeholder="e.g., Left arm, Right leg">
              </div>
              <div class="form-group">
                <label for="woundSize">Wound Size:</label>
                <input type="text" id="woundSize" formControlName="woundSize" class="form-control" 
                  placeholder="e.g., 2cm x 3cm">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="woundDepth">Wound Depth:</label>
                <select id="woundDepth" formControlName="woundDepth" class="form-control">
                  <option value="">Select depth</option>
                  <option value="Superficial">Superficial</option>
                  <option value="Partial thickness">Partial thickness</option>
                  <option value="Full thickness">Full thickness</option>
                  <option value="Deep">Deep</option>
                </select>
              </div>
              <div class="form-group">
                <label for="woundCondition">Wound Condition:</label>
                <select id="woundCondition" formControlName="woundCondition" class="form-control">
                  <option value="">Select condition</option>
                  <option value="Clean">Clean</option>
                  <option value="Contaminated">Contaminated</option>
                  <option value="Infected">Infected</option>
                  <option value="Healing">Healing</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="treatmentPlan">Treatment Plan:</label>
                <textarea id="treatmentPlan" formControlName="treatmentPlan" class="form-control" rows="3"
                  placeholder="Describe the treatment plan"></textarea>
              </div>
              <div class="form-group">
                <label for="dressingType">Dressing Type:</label>
                <select id="dressingType" formControlName="dressingType" class="form-control">
                  <option value="">Select dressing</option>
                  <option value="Gauze">Gauze</option>
                  <option value="Hydrocolloid">Hydrocolloid</option>
                  <option value="Foam">Foam</option>
                  <option value="Film">Film</option>
                  <option value="Alginate">Alginate</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="cleaningSolution">Cleaning Solution:</label>
                <select id="cleaningSolution" formControlName="cleaningSolution" class="form-control">
                  <option value="">Select solution</option>
                  <option value="Normal saline">Normal saline</option>
                  <option value="Povidone iodine">Povidone iodine</option>
                  <option value="Hydrogen peroxide">Hydrogen peroxide</option>
                  <option value="Chlorhexidine">Chlorhexidine</option>
                </select>
              </div>
              <div class="form-group">
                <label for="isRecurring">Recurring Treatment:</label>
                <input type="checkbox" id="isRecurring" formControlName="isRecurring" class="form-checkbox">
                <label for="frequency" class="frequency-label" *ngIf="woundCareForm.get('isRecurring')?.value">Frequency:</label>
                <select id="frequency" formControlName="frequency" class="form-control" 
                  *ngIf="woundCareForm.get('isRecurring')?.value">
                  <option value="">Select frequency</option>
                  <option value="Daily">Daily</option>
                  <option value="Every 2 days">Every 2 days</option>
                  <option value="Weekly">Weekly</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label for="instructions">Special Instructions:</label>
              <textarea id="instructions" formControlName="instructions" class="form-control" rows="3"
                placeholder="Any special instructions for the procedure"></textarea>
            </div>

            <div class="form-group">
              <label for="notes">Notes:</label>
              <textarea id="notes" formControlName="notes" class="form-control" rows="4"></textarea>
            </div>

            <button type="submit" class="submit-btn" [disabled]="woundCareForm.invalid || isRequestingWoundCare">
              {{ isRequestingWoundCare ? 'Requesting...' : 'Request Wound Care' }}
            </button>
          </form>
        </div>

        <!-- Suturing Form -->
        <div *ngIf="selectedProcedureType === 'suturing'" class="suturing-request-form">
          <h3>ðŸª¡ Request Suturing</h3>
          <form [formGroup]="suturingForm" (ngSubmit)="onSuturingSubmit()" class="suturing-form">
            <div class="form-row">
              <div class="form-group">
                <label for="suturingNumber">Suturing Number:</label>
                <input type="text" id="suturingNumber" formControlName="suturingNumber" class="form-control"
                  [readonly]="true" placeholder="Auto-generated suturing number">
              </div>
              <div class="form-group">
                <label for="woundType">Wound Type:</label>
                <select id="woundType" formControlName="woundType" class="form-control">
                  <option value="">Select wound type</option>
                  <option value="Laceration">Laceration</option>
                  <option value="Surgical incision">Surgical incision</option>
                  <option value="Trauma">Trauma</option>
                  <option value="Clean cut">Clean cut</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="woundLocation">Wound Location:</label>
                <input type="text" id="woundLocation" formControlName="woundLocation" class="form-control" 
                  placeholder="e.g., Left arm, Right leg">
              </div>
              <div class="form-group">
                <label for="woundSize">Wound Size:</label>
                <input type="text" id="woundSize" formControlName="woundSize" class="form-control" 
                  placeholder="e.g., 3cm x 1cm">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="woundDepth">Wound Depth:</label>
                <select id="woundDepth" formControlName="woundDepth" class="form-control">
                  <option value="">Select depth</option>
                  <option value="Superficial">Superficial</option>
                  <option value="Partial thickness">Partial thickness</option>
                  <option value="Full thickness">Full thickness</option>
                  <option value="Deep">Deep</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="sutureType">Suture Type:</label>
                <select id="sutureType" formControlName="sutureType" class="form-control">
                  <option value="">Select suture type</option>
                  <option value="Simple interrupted">Simple interrupted</option>
                  <option value="Continuous">Continuous</option>
                  <option value="Mattress">Mattress</option>
                  <option value="Subcuticular">Subcuticular</option>
                </select>
              </div>
              <div class="form-group">
                <label for="sutureMaterial">Suture Material:</label>
                <select id="sutureMaterial" formControlName="sutureMaterial" class="form-control">
                  <option value="">Select material</option>
                  <option value="Nylon">Nylon</option>
                  <option value="Polypropylene">Polypropylene</option>
                  <option value="Silk">Silk</option>
                  <option value="Vicryl">Vicryl</option>
                  <option value="Chromic">Chromic</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="sutureSize">Suture Size:</label>
                <select id="sutureSize" formControlName="sutureSize" class="form-control">
                  <option value="">Select size</option>
                  <option value="2-0">2-0</option>
                  <option value="3-0">3-0</option>
                  <option value="4-0">4-0</option>
                  <option value="5-0">5-0</option>
                  <option value="6-0">6-0</option>
                </select>
              </div>
              <div class="form-group">
                <label for="numStitches">Number of Stitches:</label>
                <input type="number" id="numStitches" formControlName="numStitches" class="form-control" 
                  min="1" placeholder="1">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="anesthesiaUsed">Anesthesia Used:</label>
                <select id="anesthesiaUsed" formControlName="anesthesiaUsed" class="form-control">
                  <option value="">Select anesthesia</option>
                  <option value="Lidocaine">Lidocaine</option>
                  <option value="Bupivacaine">Bupivacaine</option>
                  <option value="Procaine">Procaine</option>
                  <option value="None">None</option>
                </select>
              </div>
              <div class="form-group">
                <label for="followUpRequired">Follow-up Required:</label>
                <input type="checkbox" id="followUpRequired" formControlName="followUpRequired" class="form-checkbox">
                <label for="followUpDate" class="followup-label" *ngIf="suturingForm.get('followUpRequired')?.value">Follow-up Date:</label>
                <input type="date" id="followUpDate" formControlName="followUpDate" class="form-control" 
                  *ngIf="suturingForm.get('followUpRequired')?.value">
              </div>
            </div>

            <div class="form-group">
              <label for="instructions">Special Instructions:</label>
              <textarea id="instructions" formControlName="instructions" class="form-control" rows="3"
                placeholder="Any special instructions for the procedure"></textarea>
            </div>

            <div class="form-group">
              <label for="notes">Notes:</label>
              <textarea id="notes" formControlName="notes" class="form-control" rows="4"></textarea>
            </div>

            <button type="submit" class="submit-btn" [disabled]="suturingForm.invalid || isRequestingSuturing">
              {{ isRequestingSuturing ? 'Requesting...' : 'Request Suturing' }}
            </button>
          </form>
        </div>

        <!-- Ear Irrigation Form -->
        <div *ngIf="selectedProcedureType === 'ear-irrigation'" class="ear-irrigation-request-form">
          <h3>ðŸ‘‚ Request Ear Irrigation</h3>
          <form [formGroup]="earIrrigationForm" (ngSubmit)="onEarIrrigationSubmit()" class="ear-irrigation-form">
            <div class="form-row">
              <div class="form-group">
                <label for="earIrrigationNumber">Ear Irrigation Number:</label>
                <input type="text" id="earIrrigationNumber" formControlName="earIrrigationNumber" class="form-control"
                  [readonly]="true" placeholder="Auto-generated ear irrigation number">
              </div>
              <div class="form-group">
                <label for="earSide">Ear Side:</label>
                <select id="earSide" formControlName="earSide" class="form-control">
                  <option value="">Select ear</option>
                  <option value="Left">Left</option>
                  <option value="Right">Right</option>
                  <option value="Both">Both</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="irrigationSolution">Irrigation Solution:</label>
                <select id="irrigationSolution" formControlName="irrigationSolution" class="form-control">
                  <option value="">Select solution</option>
                  <option value="Warm water">Warm water</option>
                  <option value="Normal saline">Normal saline</option>
                  <option value="Hydrogen peroxide">Hydrogen peroxide</option>
                  <option value="Mineral oil">Mineral oil</option>
                </select>
              </div>
              <div class="form-group">
                <label for="solutionTemperature">Solution Temperature:</label>
                <select id="solutionTemperature" formControlName="solutionTemperature" class="form-control">
                  <option value="">Select temperature</option>
                  <option value="Body temperature">Body temperature</option>
                  <option value="Slightly warm">Slightly warm</option>
                  <option value="Room temperature">Room temperature</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="irrigationPressure">Irrigation Pressure:</label>
                <select id="irrigationPressure" formControlName="irrigationPressure" class="form-control">
                  <option value="">Select pressure</option>
                  <option value="Low">Low</option>
                  <option value="Medium">Medium</option>
                  <option value="High">High</option>
                </select>
              </div>
              <div class="form-group">
                <label for="procedureDuration">Procedure Duration (minutes):</label>
                <input type="number" id="procedureDuration" formControlName="procedureDuration" class="form-control" 
                  min="1" placeholder="30">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="findings">Findings:</label>
                <textarea id="findings" formControlName="findings" class="form-control" rows="3"
                  placeholder="Describe what was found during the procedure"></textarea>
              </div>
              <div class="form-group">
                <label for="complications">Complications:</label>
                <textarea id="complications" formControlName="complications" class="form-control" rows="3"
                  placeholder="Any complications observed"></textarea>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="followUpRequired">Follow-up Required:</label>
                <input type="checkbox" id="followUpRequired" formControlName="followUpRequired" class="form-checkbox">
                <label for="followUpDate" class="followup-label" *ngIf="earIrrigationForm.get('followUpRequired')?.value">Follow-up Date:</label>
                <input type="date" id="followUpDate" formControlName="followUpDate" class="form-control" 
                  *ngIf="earIrrigationForm.get('followUpRequired')?.value">
              </div>
            </div>

            <div class="form-group">
              <label for="instructions">Special Instructions:</label>
              <textarea id="instructions" formControlName="instructions" class="form-control" rows="3"
                placeholder="Any special instructions for the procedure"></textarea>
            </div>

            <div class="form-group">
              <label for="notes">Notes:</label>
              <textarea id="notes" formControlName="notes" class="form-control" rows="4"></textarea>
            </div>

            <button type="submit" class="submit-btn" [disabled]="earIrrigationForm.invalid || isRequestingEarIrrigation">
              {{ isRequestingEarIrrigation ? 'Requesting...' : 'Request Ear Irrigation' }}
            </button>
          </form>
        </div>

        <!-- Procedures List -->
        <div class="procedures-list">
          <h3>Patient Procedures</h3>
          
          <!-- Injection Procedures Table -->
          <div *ngIf="selectedProcedureType === 'injection'" class="table-container">
            <table class="procedures-table">
              <thead>
                <tr>
                  <th>Injection Number</th>
                  <th>Injection Date</th>
                  <th>Medication</th>
                  <th>Dose</th>
                  <th>Route</th>
                  <th>Site</th>
                  <th>Status</th>
                  <th>Physician</th>
                  <th>Recurring</th>
                  <th>Total Doses</th>
                  <th>Administered</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let injection of injections">
                  <td>{{ injection.InjectionNumber }}</td>
                  <td>{{ injection.InjectionDate | date:'short' }}</td>
                  <td>
                    {{ injection.MedicationName }}
                    <span *ngIf="injection.Strength">({{ injection.Strength }} {{ injection.DosageForm }})</span>
                  </td>
                  <td>{{ injection.Dose }}</td>
                  <td>{{ injection.Route }}</td>
                  <td>{{ injection.Site }}</td>
                  <td>
                    <span class="status-badge" [class]="injection.Status?.toLowerCase()">
                      {{ injection.Status }}
                    </span>
                  </td>
                  <td>{{ injection.OrderingPhysicianName }}</td>
                  <td>
                    <span class="badge" [class.recurring]="injection.IsRecurring"
                      [class.one-time]="!injection.IsRecurring">
                      {{ injection.IsRecurring ? 'Yes' : 'No' }}
                    </span>
                  </td>
                  <td>{{ injection.TotalDoses }}</td>
                  <td>{{ injection.AdministeredDoses || 0 }}/{{ injection.TotalDoses }}</td>
                  <td>
                    <button type="button" class="action-btn view" (click)="viewInjectionDetails(injection.InjectionID)">
                      View Details
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          <div class="no-results" *ngIf="injections.length === 0">
              No injection procedures found for this patient.
        </div>
      </div>

          <!-- Wound Care Procedures Table -->
          <div *ngIf="selectedProcedureType === 'wound-care'" class="table-container">
            <table class="procedures-table">
              <thead>
                <tr>
                  <th>Wound Care Number</th>
                  <th>Procedure Date</th>
                  <th>Wound Type</th>
                  <th>Wound Location</th>
                  <th>Wound Size</th>
                  <th>Treatment Plan</th>
                  <th>Status</th>
                  <th>Physician</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let procedure of woundCareProcedures">
                  <td>{{ procedure.WoundCareNumber || procedure.ProcedureNumber }}</td>
                  <td>{{ procedure.ProcedureDate | date:'short' }}</td>
                  <td>{{ procedure.WoundType }}</td>
                  <td>{{ procedure.WoundLocation }}</td>
                  <td>{{ procedure.WoundSize }}</td>
                  <td>{{ procedure.TreatmentPlan }}</td>
                  <td>
                    <span class="status-badge" [class]="procedure.Status?.toLowerCase()">
                      {{ procedure.Status }}
                    </span>
                  </td>
                  <td>{{ procedure.OrderingPhysicianName }}</td>
                  <td>
                    <button type="button" class="action-btn view" (click)="viewWoundCareDetails(procedure.WoundCareID || procedure.ProcedureID)">
                      View Details
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
            <div class="no-results" *ngIf="woundCareProcedures.length === 0">
              No wound care procedures found for this patient.
                </div>
              </div>

          <!-- Suturing Procedures Table -->
          <div *ngIf="selectedProcedureType === 'suturing'" class="table-container">
            <table class="procedures-table">
              <thead>
                <tr>
                  <th>Suturing Number</th>
                  <th>Procedure Date</th>
                  <th>Wound Type</th>
                  <th>Wound Location</th>
                  <th>Suture Type</th>
                  <th>Number of Stitches</th>
                  <th>Status</th>
                  <th>Physician</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let procedure of suturingProcedures">
                  <td>{{ procedure.SuturingNumber || procedure.ProcedureNumber }}</td>
                  <td>{{ procedure.ProcedureDate | date:'short' }}</td>
                  <td>{{ procedure.WoundType }}</td>
                  <td>{{ procedure.WoundLocation }}</td>
                  <td>{{ procedure.SutureType }}</td>
                  <td>{{ procedure.NumberOfStitches }}</td>
                  <td>
                    <span class="status-badge" [class]="procedure.Status?.toLowerCase()">
                      {{ procedure.Status }}
                    </span>
                  </td>
                  <td>{{ procedure.OrderingPhysicianName }}</td>
                  <td>
                    <button type="button" class="action-btn view" (click)="viewSuturingDetails(procedure.SuturingID || procedure.ProcedureID)">
                      View Details
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
            <div class="no-results" *ngIf="suturingProcedures.length === 0">
              No suturing procedures found for this patient.
              </div>
            </div>

          <!-- Ear Irrigation Procedures Table -->
          <div *ngIf="selectedProcedureType === 'ear-irrigation'" class="table-container">
            <table class="procedures-table">
              <thead>
                <tr>
                  <th>Ear Irrigation Number</th>
                  <th>Procedure Date</th>
                  <th>Ear Side</th>
                  <th>Irrigation Solution</th>
                  <th>Solution Temperature</th>
                  <th>Duration (min)</th>
                  <th>Status</th>
                  <th>Physician</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let procedure of earIrrigationProcedures">
                  <td>{{ procedure.EarIrrigationNumber || procedure.ProcedureNumber }}</td>
                  <td>{{ procedure.ProcedureDate | date:'short' }}</td>
                  <td>{{ procedure.EarSide }}</td>
                  <td>{{ procedure.IrrigationSolution }}</td>
                  <td>{{ procedure.SolutionTemperature }}</td>
                  <td>{{ procedure.ProcedureDuration }}</td>
                  <td>
                    <span class="status-badge" [class]="procedure.Status?.toLowerCase()">
                      {{ procedure.Status }}
                    </span>
                  </td>
                  <td>{{ procedure.OrderingPhysicianName }}</td>
                  <td>
                    <button type="button" class="action-btn view" (click)="viewEarIrrigationDetails(procedure.EarIrrigationID || procedure.ProcedureID)">
                      View Details
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
            <div class="no-results" *ngIf="earIrrigationProcedures.length === 0">
              No ear irrigation procedures found for this patient.
          </div>
        </div>
        </div>
      </div>

      <!-- Sick Leave Tab -->
      <div *ngIf="selectedTab === 'sick-leave'">
        <app-sick-leave [patientID]="patient?.CardNumber" [createdBy]="createdBy">
        </app-sick-leave>
      </div>
      <div *ngIf="selectedTab === 'referrals'">
        <app-referral-tab [patient]="patient" [createdBy]="createdBy"></app-referral-tab>
      </div>
    </div>
  </div>
</div>