<div class="expense-container">
  <h2>Medical Expense Reimbursement</h2>
  
  <!-- Include ClinicMedicalExpenseFormComponent for form submission -->
  <!-- <app-clinic-medical-expense-form (reimbursementSubmitted)="onReimbursementSubmitted($event)"></app-clinic-medical-expense-form> -->

  <div class="search-container">
    <input type="text" [(ngModel)]="searchTerm" (input)="filterReimbursements()" placeholder="Search by Payroll No or Patient Name">
  </div>

  <div class="reimbursements-list">
    <h3>Reimbursement Requests</h3>
    <div class="table-container">
      <table class="reimbursements-table">
        <thead>
          <tr>
            <th>Request ID</th>
            <th>Patient Name</th>
            <th>Payroll No</th>
            <th>Department</th>
            <th>Total Amount</th>
            <th>Status</th>
            <th>Submission Date</th>
            <th>Details</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let reimbursement of filteredReimbursements">
            <td>{{ reimbursement.reimbursementID }}</td>
            <td>{{ reimbursement.patientName }}</td>
            <td>{{ reimbursement.payrollNo }}</td>
            <td>{{ reimbursement.department }}</td>
            <td>{{ reimbursement.totalAmount | currency:'ETB':'symbol':'1.2-2' }}</td>
            <td>
              <span class="status-badge" [ngClass]="reimbursement.status">
                {{ reimbursement.status | titlecase }}
              </span>
            </td>
            <td>{{ reimbursement.submissionDate ? (reimbursement.submissionDate | date:'short') : 'N/A' }}</td>
            <td>
              <button class="action-btn details" (click)="viewDetails(reimbursement)">View Details</button>
            </td>
            <td>
              <button 
                *ngIf="(reimbursement.status || '').toLowerCase() === 'pending'" 
                class="action-btn approve"
                (click)="updateReimbursementStatus(reimbursement.reimbursementID, 'approved')">
                Approve
              </button>
              <button 
                *ngIf="(reimbursement.status || '').toLowerCase() === 'pending'" 
                class="action-btn reject"
                (click)="updateReimbursementStatus(reimbursement.reimbursementID, 'rejected')">
                Reject
              </button>
              <button 
                *ngIf="(reimbursement.status || '').toLowerCase() === 'approved'" 
                class="action-btn pay"
                (click)="updateReimbursementStatus(reimbursement.reimbursementID, 'paid')">
                Mark as Paid
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Details Modal -->
  <div class="modal" *ngIf="showDetailsModal">
    <div class="modal-content">
      <h3>Reimbursement Details for ID: {{ selectedReimbursement?.reimbursementID }}</h3>
      
      <h4>Investigations</h4>
      <table>
        <thead>
          <tr>
            <th>Investigation Type</th>
            <th>Done At</th>
            <th>Ordered From</th>
            <th>Amount</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let inv of investigations">
            <td>{{ inv.InvestigationType }}</td>
            <td>{{ inv.Location }}</td>
            <td>{{ inv.OrderedFrom || 'N/A' }}</td>
            <td>{{ inv.Amount | currency:'ETB' }}</td>
            <td>{{ inv.InvestigationDate ? (inv.InvestigationDate | date:'short') : 'N/A' }}</td>
          </tr>
        </tbody>
      </table>

      <h4>Documents</h4>
      <div class="documents-list">
        <div *ngFor="let doc of documents" class="document-item">
          <p><strong>Description:</strong> {{ doc.description }}</p>
          <p><strong>File Name:</strong> {{ doc.fileName }}</p>
          <p><strong>Upload Date:</strong> {{ doc.uploadDate ? (doc.uploadDate | date:'short') : 'N/A' }}</p>
          <div *ngIf="doc.previewType !== 'none'" class="preview-container">
            <ng-container *ngIf="doc.previewType === 'pdf'">
              <embed [src]="doc.previewUrl" type="application/pdf" width="100%" height="400px" />
            </ng-container>
            <ng-container *ngIf="doc.previewType === 'image'">
              <img [src]="doc.previewUrl" alt="{{doc.description}}" style="max-width: 100%; height: auto;">
            </ng-container>
            <ng-container *ngIf="doc.previewType === 'office'">
              <iframe [src]="doc.previewUrl" width="100%" height="480" frameborder="0"></iframe>
            </ng-container>
          </div>
          <a [attr.href]="doc.downloadUrl" download="{{doc.fileName}}" target="_blank">Download</a>
        </div>
        <div *ngIf="documents.length === 0">No documents uploaded.</div>
      </div>
      
      <div class="modal-actions" *ngIf="selectedReimbursement as sr">
        <div style="margin: 10px 0;">
          <span class="status-badge" [ngClass]="(sr.status || '').toLowerCase()">Current Status: {{ (sr.status || 'Unknown') | titlecase }}</span>
        </div>
        <div>
          <button 
            *ngIf="(sr.status || '').toLowerCase() === 'pending'"
            class="action-btn approve"
            (click)="updateReimbursementStatus(sr.reimbursementID, 'approved')">
            Approve
          </button>
          <button 
            *ngIf="(sr.status || '').toLowerCase() === 'pending'"
            class="action-btn reject"
            (click)="updateReimbursementStatus(sr.reimbursementID, 'rejected')">
            Reject
          </button>
          <button 
            *ngIf="(sr.status || '').toLowerCase() === 'approved'"
            class="action-btn pay"
            (click)="updateReimbursementStatus(sr.reimbursementID, 'paid')">
            Mark as Paid
          </button>
        </div>
      </div>

      <button type="button" class="close-btn" (click)="closeDetailsModal()">Close</button>
    </div>
  </div>
</div>