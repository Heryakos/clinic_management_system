<div class="expense-container">
  <h2>Medical Expense Reimbursement</h2>

  <div class="search-container">
    <input type="text" [(ngModel)]="searchTerm" (input)="filterReimbursements()"
      placeholder="Search by Payroll No or Patient Name" />
  </div>

  <div class="reimbursements-list">
    <h3>Reimbursement Requests</h3>
    <div class="table-container">
      <table class="reimbursements-table">
        <thead>
          <tr>
            <!-- <th>Request ID</th> -->
            <th>Patient Name</th>
            <th>Payroll No</th>
            <th>Department</th>
            <th>Total Amount</th>
            <th>Status</th>
            <th>Submission Date</th>
            <th>Details</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let reimbursement of filteredReimbursements">
            <!-- <td>{{ reimbursement.reimbursementID }}</td> -->
            <td>{{ reimbursement.patientName }}</td>
            <td>{{ reimbursement.payrollNo }}</td>
            <td>{{ reimbursement.department }}</td>
            <td>{{ reimbursement.totalAmount | currency: 'ETB':'symbol':'1.2-2' }}</td>
            <td>
              <span class="status-badge" [ngClass]="getStatusClass(reimbursement.status)">
                {{ getStatusDisplay(reimbursement.status) | titlecase }}
              </span>
            </td>
            <td>{{ reimbursement.submissionDate ? (reimbursement.submissionDate | date: 'short') : 'N/A' }}</td>
            <td>
              <button type="button" class="action-btn details" (click)="viewDetails(reimbursement)">View
                Details</button>
            </td>
            <td>
              <button type="button" *ngIf="isPending(reimbursement.status)" class="action-btn approve"
                (click)="openStatusUpdateDialog(reimbursement.reimbursementID, undefined, 'approved')">
                Approve
              </button>
              <button type="button" *ngIf="isPending(reimbursement.status)" class="action-btn reject"
                (click)="openStatusUpdateDialog(reimbursement.reimbursementID, undefined, 'rejected')">
                Reject
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Details Modal -->
  <div class="modal" *ngIf="showDetailsModal">
    <div class="modal-backdrop" (click)="closeDetailsModal()"></div>
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Reimbursement Details</h3>
        <button type="button" class="close-btn" (click)="closeDetailsModal()">&times;</button>
      </div>

      <div class="modal-body">
        <div class="section">
          <h4>Basic Information</h4>
          <div class="info-grid">
            <div class="info-item">
              <label>Approved Amount:</label>
              <span class="amount">{{ getTotalApprovedAmount() | currency: 'ETB':'symbol':'1.2-2' }}</span>
            </div>
            <div class="info-item">
              <label>Reimbursement Number:</label>
              <span>{{ selectedReimbursement?.reimbursementNumber || 'N/A' }}</span>
            </div>
            <div class="info-item">
              <label>Patient Name:</label>
              <span>{{ selectedReimbursement?.patientName }}</span>
            </div>
            <div class="info-item">
              <label>Payroll Number:</label>
              <span>{{ selectedReimbursement?.payrollNo }}</span>
            </div>
            <div class="info-item">
              <label>Department:</label>
              <span>{{ selectedReimbursement?.department }}</span>
            </div>
            <div class="info-item">
              <label>Total Amount:</label>
              <span class="amount">{{ selectedReimbursement?.totalAmount | currency: 'ETB':'symbol':'1.2-2' }}</span>
            </div>
            <div class="info-item">
              <label>Status:</label>
              <span class="status-badge" [ngClass]="getStatusClass(selectedReimbursement?.status)">
                {{ getStatusDisplay(selectedReimbursement?.status) | titlecase }}
              </span>
            </div>
            <div class="info-item">
              <label>Submission Date:</label>
              <span>{{ selectedReimbursement?.submissionDate ? (selectedReimbursement?.submissionDate | date: 'short') :
                'N/A' }}</span>
            </div>
            <div class="info-item">
              <label>Form Type:</label>
              <span>{{ selectedReimbursement?.formType || 'N/A' }}</span>
            </div>
            <div class="info-item full-width">
              <label>Comments:</label>
              <span class="comments">{{ selectedReimbursement?.comments || 'None' }}</span>
            </div>
          </div>
        </div>

        <!-- Investigations Section -->
        <div class="section" *ngIf="investigations.length > 0">
          <h4>Investigations & Invoices</h4>
          <div class="investigation-summary">
            <div class="summary-item">
              <span class="label">Total Investigations:</span>
              <span class="value">{{ investigations.length }}</span>
            </div>
            <div class="summary-item">
              <span class="label">Pending:</span>
              <span class="value pending">{{ getInvestigationCountByStatus('pending') }}</span>
            </div>
            <div class="summary-item">
              <span class="label">Approved:</span>
              <span class="value approved">{{ getInvestigationCountByStatus('approved') }}</span>
            </div>
            <div class="summary-item">
              <span class="label">Rejected:</span>
              <span class="value rejected">{{ getInvestigationCountByStatus('rejected') }}</span>
            </div>
          </div>

          <div class="table-wrapper">
            <table class="details-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Service Type</th>
                  <th>Invoice Number</th>
                  <th>Done At</th>
                  <th>Ordered From</th>
                  <th>Amount</th>
                  <th>Date</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let inv of investigations; let i = index"
                  [class.approved-row]="getStatusClass(inv.status) === 'approved'"
                  [class.rejected-row]="getStatusClass(inv.status) === 'rejected'">
                  <td>{{ i + 1 }}</td>
                  <td>{{ inv.InvestigationType || 'N/A' }}</td>
                  <td class="invoice-number">{{ inv.InvoiceNumber || 'N/A' }}</td>
                  <td>{{ inv.Location || 'N/A' }}</td>
                  <td>{{ inv.OrderedFrom || 'N/A' }}</td>
                  <td class="amount">{{ inv.Amount | currency:'ETB' }}</td>
                  <td>{{ inv.InvestigationDate ? (inv.InvestigationDate | date:'short') : 'N/A' }}</td>
                  <td>
                    <span class="status-badge" [ngClass]="getStatusClass(inv.status)">
                      {{ getStatusDisplay(inv.status) | titlecase }}
                    </span>
                  </td>
                  <td>
                    <div class="action-buttons" *ngIf="isPending(inv.status)">
                      <button type="button" class="action-btn approve"
                        (click)="openStatusUpdateDialog(selectedReimbursement!.reimbursementID, inv.DetailID, 'approved')">
                        Approve
                      </button>
                      <button type="button" class="action-btn reject"
                        (click)="openStatusUpdateDialog(selectedReimbursement!.reimbursementID, inv.DetailID, 'rejected')">
                        Reject
                      </button>
                    </div>
                    <div *ngIf="!isPending(inv.status)" class="status-comments">
                      <small *ngIf="inv.comments">Comment: {{ inv.comments }}</small>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Documents Section -->
        <div class="section">
          <h4>Uploaded Documents ({{ documents.length }})</h4>
          <app-reimbursement-documents-viewer 
          [reimbursementId]="selectedReimbursement!.reimbursementID!"
          title="Reimbursement Documents">
        </app-reimbursement-documents-viewer>
           <!--<div *ngIf="documents.length > 0; else noDocuments">
            <div class="documents-list"> -->

              <!-- 1. Clinic Medical Expense Refund Form - Always shown first and highlighted -->
              <!-- <div *ngFor="let formDoc of clinicForms" class="document-item primary-document">
                <div class="doc-header">
                  <h5>
                    <span class="form-icon">üìã</span>
                    <strong>Clinic Medical Expense Refund Form</strong>
                  </h5>
                  <button type="button" class="download-btn" (click)="downloadDocument(formDoc)">
                    <span class="download-icon">‚Üì</span> Download Form
                  </button>
                </div>
                <div class="doc-details">
                  <p><strong>File:</strong> {{ formDoc.FileName }}</p>
                  <p><strong>Size:</strong> {{ formatFileSize(formDoc.FileSize) }}</p>
                  <p><strong>Uploaded:</strong> {{ formDoc.uploadDate | date:'medium' }} by {{ formDoc.UploadedBy }}</p>
                </div>

                <div class="preview-container" *ngIf="formDoc.previewType === 'pdf'">
                  <div class="preview-header">Form Preview</div>
                  <div class="preview-frame">
                    <embed [src]="getPdfPreviewUrl(formDoc)" type="application/pdf" width="100%" height="600px" />
                  </div>
                </div>
              </div> -->

              <!-- 2. Supporting Documents (Invoices/Receipts) -->
              <!-- <div *ngIf="supportingDocuments.length > 0" class="supporting-docs-section">
                <h5 class="section-subtitle">
                  <span class="invoice-icon">üßæ</span>
                  Supporting Documents ({{ supportingDocuments.length }})
                </h5>

                <div *ngFor="let doc of supportingDocuments" class="document-item supporting-document">
                  <div class="doc-header">
                    <h6>{{ doc.DocumentDescription || 'Supporting Document' }}</h6>
                    <button type="button" class="download-btn small" (click)="downloadDocument(doc)">
                      <span class="download-icon">‚Üì</span> Download
                    </button>
                  </div>
                  <div class="doc-details">
                    <p><strong>File:</strong> {{ doc.FileName }}</p>
                    <p><strong>Size:</strong> {{ formatFileSize(doc.FileSize) }}</p>
                    <p><strong>Uploaded:</strong> {{ doc.uploadDate | date:'medium' }}</p>
                  </div>

                  <div class="preview-container" *ngIf="doc.previewType !== 'none'">
                    <div class="preview-header">Preview</div>
                    <div class="preview-frame">
                      <ng-container *ngIf="doc.previewType === 'pdf'">
                        <div class="preview-frame"> -->
                          <!-- Loading -->
                          <!-- <div *ngIf="pdfLoading[doc.DocumentID]" class="preview-loading">
                            <div class="spinner"></div>
                            <p>Loading PDF preview...</p>
                          </div>
                       -->
                          <!-- Error + Retry -->
                          <!-- <div *ngIf="!pdfLoading[doc.DocumentID] && pdfLoadErrors[doc.DocumentID]" class="preview-error">
                            <p>‚ö†Ô∏è {{ pdfLoadErrors[doc.DocumentID] }}</p>
                            <div class="error-actions">
                              <button type="button" class="retry-btn" (click)="retryPdfLoad(doc)"
                                      [disabled]="(pdfRetryCount[doc.DocumentID] || 0) >= 3">
                                üîÑ Retry {{ pdfRetryCount[doc.DocumentID] > 0 ? '(' + pdfRetryCount[doc.DocumentID] + '/3)' : '' }}
                              </button>
                              <button type="button" class="download-btn small" (click)="downloadDocument(doc)">
                                ‚Üì Download Instead
                              </button>
                            </div>
                          </div> -->
                      
                          <!-- Success -->
                          <!-- <embed *ngIf="!pdfLoading[doc.DocumentID] && !pdfLoadErrors[doc.DocumentID]"
                                 [src]="getPdfPreviewUrl(doc)"
                                 type="application/pdf"
                                 width="100%"
                                 height="500px" />
                        </div>
                      </ng-container>
                      <ng-container *ngIf="doc.previewType === 'image'">
                        <img [src]="doc.previewUrl" class="preview-image" alt="Document preview" />
                      </ng-container>
                    </div>
                  </div>
                </div>
              </div> -->

              <!-- Fallback if no supporting docs but has form -->
              <!-- <div *ngIf="supportingDocuments.length === 0 && clinicForms.length > 0" class="info-note">
                <p>‚ÑπÔ∏è No supporting documents (invoices/receipts) uploaded yet.</p>
              </div>

            </div>
          </div>

          <ng-template #noDocuments>
            <div class="empty-state">
              <p>No documents have been uploaded for this reimbursement request.</p>
            </div>
          </ng-template> -->
        </div>





      </div>

      <div class="modal-actions" *ngIf="selectedReimbursement as sr">
        <div class="current-status">
          <span class="status-badge large" [ngClass]="getStatusClass(sr.status)">
            Current Status: {{ getStatusDisplay(sr.status) | titlecase }}
          </span>
          <div class="approved-amount" *ngIf="getTotalApprovedAmount() > 0">
            Total Approved: {{ getTotalApprovedAmount() | currency: 'ETB':'symbol':'1.2-2' }}
          </div>
        </div>
        <div class="action-buttons">
          <button type="button" *ngIf="isPending(sr.status)" class="action-btn approve"
            (click)="openStatusUpdateDialog(sr.reimbursementID, undefined, 'approved')">
            Approve All
          </button>
          <button type="button" *ngIf="isPending(sr.status)" class="action-btn reject"
            (click)="openStatusUpdateDialog(sr.reimbursementID, undefined, 'rejected')">
            Reject All
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Comment Dialog for Status Updates -->
  <div class="modal" *ngIf="showCommentDialog">
    <div class="modal-content comment-dialog">
      <div class="modal-header">
        <h3>Update Reimbursement Status</h3>
        <button type="button" class="close-btn" (click)="closeCommentDialog()">&times;</button>
      </div>

      <div class="modal-body">
        <div class="status-info">
          <p>
            <strong>Updating status to:</strong>
            <span class="status-badge" [ngClass]="getStatusClass(pendingStatusUpdate?.status)">
              {{ getStatusDisplay(pendingStatusUpdate?.status) | titlecase }}
            </span>
          </p>
          <p>
            <strong>ID:</strong>
            {{ pendingStatusUpdate!.detailId ? 'Detail ' + pendingStatusUpdate!.detailId : 'Reimbursement ' +
            pendingStatusUpdate!.id }}
          </p>
        </div>

        <div class="comment-input">
          <label for="statusComment">Comment:</label>
          <textarea id="statusComment" [(ngModel)]="statusComment"
            placeholder="Please provide a comment for this status update (optional)..." rows="4"
            class="comment-textarea"></textarea>
          <small class="comment-required">* Comment is optional</small>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="action-btn cancel" (click)="closeCommentDialog()">Cancel</button>
        <button type="button" class="action-btn confirm" (click)="updateReimbursementStatus()">
          Confirm Update
        </button>
      </div>
    </div>
  </div>
</div>