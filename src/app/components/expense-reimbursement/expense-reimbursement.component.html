<div class="expense-container">
  <h2>Medical Expense Reimbursement</h2>

  <div class="search-container">
    <input
      type="text"
      [(ngModel)]="searchTerm"
      (input)="filterReimbursements()"
      placeholder="Search by Payroll No or Patient Name"
    />
  </div>

  <div class="reimbursements-list">
    <h3>Reimbursement Requests</h3>
    <div class="table-container">
      <table class="reimbursements-table">
        <thead>
          <tr>
            <th>Request ID</th>
            <th>Patient Name</th>
            <th>Payroll No</th>
            <th>Department</th>
            <th>Total Amount</th>
            <th>Status</th>
            <th>Submission Date</th>
            <th>Details</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let reimbursement of filteredReimbursements">
            <td>{{ reimbursement.reimbursementID }}</td>
            <td>{{ reimbursement.patientName }}</td>
            <td>{{ reimbursement.payrollNo }}</td>
            <td>{{ reimbursement.department }}</td>
            <td>{{ reimbursement.totalAmount | currency: 'ETB':'symbol':'1.2-2' }}</td>
            <td>
              <span class="status-badge" [ngClass]="reimbursement.status.toLowerCase()">
                {{ reimbursement.status | titlecase }}
              </span>
            </td>
            <td>{{ reimbursement.submissionDate ? (reimbursement.submissionDate | date: 'short') : 'N/A' }}</td>
            <td>
              <button type="button" class="action-btn details" (click)="viewDetails(reimbursement)">View Details</button>
            </td>
            <td>
              <button type="button" 
                *ngIf="reimbursement.status.toLowerCase() === 'pending'"
                class="action-btn approve"
                (click)="openStatusUpdateDialog(reimbursement.reimbursementID, undefined, 'approved')"
              >
                Approve
              </button>
              <button type="button"
                *ngIf="reimbursement.status.toLowerCase() === 'pending'"
                class="action-btn reject"
                (click)="openStatusUpdateDialog(reimbursement.reimbursementID, undefined, 'rejected')"
              >
                Reject
              </button>
              <button type="button"
                *ngIf="['approved', 'partial'].includes(reimbursement.status.toLowerCase())"
                class="action-btn pay"
                (click)="openStatusUpdateDialog(reimbursement.reimbursementID, undefined, 'paid')"
              >
                Mark as Paid
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Details Modal -->
  <div class="modal" *ngIf="showDetailsModal">
    <div class="modal-backdrop" (click)="closeDetailsModal()"></div>
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Reimbursement Details</h3>
        <button class="close-btn" (click)="closeDetailsModal()">&times;</button>
      </div>

      <div class="modal-body">
        <div class="section">
          <h4>Basic Information</h4>
          <div class="info-grid">
            <div class="info-item">
              <label>Approved Amount:</label>
              <span class="amount">{{ getTotalApprovedAmount() | currency: 'ETB':'symbol':'1.2-2' }}</span>
            </div>
            <div class="info-item">
              <label>Reimbursement Number:</label>
              <span>{{ selectedReimbursement?.reimbursementNumber || 'N/A' }}</span>
            </div>
            <div class="info-item">
              <label>Patient Name:</label>
              <span>{{ selectedReimbursement?.patientName }}</span>
            </div>
            <div class="info-item">
              <label>Payroll Number:</label>
              <span>{{ selectedReimbursement?.payrollNo }}</span>
            </div>
            <div class="info-item">
              <label>Department:</label>
              <span>{{ selectedReimbursement?.department }}</span>
            </div>
            <div class="info-item">
              <label>Total Amount:</label>
              <span class="amount">{{ selectedReimbursement?.totalAmount | currency: 'ETB':'symbol':'1.2-2' }}</span>
            </div>
            <div class="info-item">
              <label>Status:</label>
              <span class="status-badge" [ngClass]="selectedReimbursement?.status?.toLowerCase()">
                {{ selectedReimbursement?.status | titlecase }}
              </span>
            </div>
            <div class="info-item">
              <label>Submission Date:</label>
              <span>{{ selectedReimbursement?.submissionDate ? (selectedReimbursement?.submissionDate | date: 'short') : 'N/A' }}</span>
            </div>
            <div class="info-item">
              <label>Form Type:</label>
              <span>{{ selectedReimbursement?.formType || 'N/A' }}</span>
            </div>
            <div class="info-item full-width">
              <label>Comments:</label>
              <span class="comments">{{ selectedReimbursement?.comments || 'None' }}</span>
            </div>
          </div>
        </div>

        <!-- Investigations Section -->
        <div class="section" *ngIf="investigations.length > 0">
          <h4>Investigations & Invoices</h4>
          <div class="investigation-summary">
            <div class="summary-item">
              <span class="label">Total Investigations:</span>
              <span class="value">{{ investigations.length }}</span>
            </div>
            <div class="summary-item">
              <span class="label">Pending:</span>
              <span class="value pending">{{ getInvestigationCountByStatus('pending') }}</span>
            </div>
            <div class="summary-item">
              <span class="label">Approved:</span>
              <span class="value approved">{{ getInvestigationCountByStatus('approved') }}</span>
            </div>
            <div class="summary-item">
              <span class="label">Rejected:</span>
              <span class="value rejected">{{ getInvestigationCountByStatus('rejected') }}</span>
            </div>
          </div>
          
          <div class="table-wrapper">
            <table class="details-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Investigation Type</th>
                  <th>Invoice Number</th>
                  <th>Location</th>
                  <th>Ordered From</th>
                  <th>Amount</th>
                  <th>Date</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let inv of investigations; let i = index" 
                    [class.approved-row]="inv.status?.toLowerCase() === 'approved'"
                    [class.rejected-row]="inv.status?.toLowerCase() === 'rejected'">
                  <td>{{ i + 1 }}</td>
                  <td>{{ inv.InvestigationType }}</td>
                  <td class="invoice-number">{{ inv.InvoiceNumber || 'N/A' }}</td>
                  <td>{{ inv.Location }}</td>
                  <td>{{ inv.OrderedFrom || 'N/A' }}</td>
                  <td class="amount">{{ inv.Amount | currency: 'ETB' }}</td>
                  <td>{{ inv.InvestigationDate ? (inv.InvestigationDate | date: 'short') : 'N/A' }}</td>
                  <td>
                    <span class="status-badge" [ngClass]="(inv.status || 'pending').toLowerCase()">
                      {{ (inv.status || 'Pending') | titlecase }}
                    </span>
                  </td>
                  <td>
                    <div class="action-buttons" *ngIf="(inv.status || 'pending').toLowerCase() === 'pending'">
                      <button class="action-btn approve" 
                              (click)="openStatusUpdateDialog(selectedReimbursement!.reimbursementID, inv.DetailID, 'approved')">
                        Approve
                      </button>
                      <button class="action-btn reject" 
                              (click)="openStatusUpdateDialog(selectedReimbursement!.reimbursementID, inv.DetailID, 'rejected')">
                        Reject
                      </button>
                    </div>
                    <div *ngIf="(inv.status || 'pending').toLowerCase() !== 'pending'" class="status-comments">
                      <small *ngIf="inv.comments">Comment: {{ inv.comments }}</small>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Documents Section -->
        <div class="section">
          <h4>Uploaded Documents</h4>
          <div *ngIf="documents.length > 0; else noDocuments">
            <div class="documents-list">
              <div *ngFor="let doc of documents" class="document-item">
                <div class="document-info">
                  <div class="doc-header">
                    <h5>{{ doc.DocumentDescription || 'Document' }}</h5>
                    <button class="download-btn" (click)="downloadDocument(doc)">
                      <span class="download-icon">↓</span> Download
                    </button>
                  </div>
                  <p><strong>File Name:</strong> {{ doc.FileName }}</p>
                  <p><strong>Upload Date:</strong> {{ doc.uploadDate ? (doc.uploadDate | date: 'short') : 'N/A' }}</p>
                </div>

                <div *ngIf="doc.previewType !== 'none'" class="preview-container">
                  <div class="preview-header">
                    <span>Preview</span>
                    <button class="download-btn" (click)="downloadDocument(doc)">
                      <span class="download-icon">↓</span> Download
                    </button>
                  </div>
                  <ng-container *ngIf="doc.previewType === 'pdf'">
                    <div class="preview-frame">
                      <ng-container *ngIf="pdfLoading[doc.DocumentID]">
                        <div class="preview-loading">
                          <span class="spinner"></span>
                          Loading PDF...
                        </div>
                      </ng-container>
                      <ng-container *ngIf="pdfLoadErrors[doc.DocumentID]; else pdfEmbed">
                        <div class="preview-error">
                          <p>⚠️ {{ pdfLoadErrors[doc.DocumentID] }}</p>
                          <button class="download-btn" (click)="downloadDocument(doc)">
                            <span class="download-icon">↓</span> Download Instead
                          </button>
                        </div>
                      </ng-container>
                      <ng-template #pdfEmbed>
                        <embed [src]="getPdfPreviewUrl(doc)" type="application/pdf" width="100%" height="400px" />
                      </ng-template>
                    </div>
                  </ng-container>
                  <ng-container *ngIf="doc.previewType === 'image'">
                    <div class="preview-frame">
                      <img [src]="doc.previewUrl" alt="{{ doc.DocumentDescription }}" class="preview-image" />
                    </div>
                  </ng-container>
                  <ng-container *ngIf="doc.previewType === 'office'">
                    <div class="preview-frame">
                      <iframe [src]="doc.previewUrl" width="100%" height="400px" frameborder="0"></iframe>
                    </div>
                  </ng-container>
                </div>
              </div>
            </div>
          </div>
          <ng-template #noDocuments>
            <p class="no-data">No documents uploaded for this reimbursement.</p>
          </ng-template>
        </div>
      </div>

      <div class="modal-actions" *ngIf="selectedReimbursement as sr">
        <div class="current-status">
          <span class="status-badge large" [ngClass]="sr.status.toLowerCase()">
            Current Status: {{ sr.status | titlecase }}
          </span>
          <div class="approved-amount" *ngIf="getTotalApprovedAmount() > 0">
            Total Approved: {{ getTotalApprovedAmount() | currency: 'ETB':'symbol':'1.2-2' }}
          </div>
        </div>
        <div class="action-buttons">
          <button
            type="button"
            *ngIf="sr.status.toLowerCase() === 'pending'"
            class="action-btn approve"
            (click)="openStatusUpdateDialog(sr.reimbursementID, undefined, 'approved')"
          >
            Approve All
          </button>
          <button
            type="button"
            *ngIf="sr.status.toLowerCase() === 'pending'"
            class="action-btn reject"
            (click)="openStatusUpdateDialog(sr.reimbursementID, undefined, 'rejected')"
          >
            Reject All
          </button>
          <button
            type="button"
            *ngIf="['approved', 'partial'].includes(sr.status.toLowerCase())"
            class="action-btn pay"
            (click)="openStatusUpdateDialog(sr.reimbursementID, undefined, 'paid')"
          >
            Mark as Paid
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Comment Dialog for Status Updates -->
  <div class="modal" *ngIf="showCommentDialog">
    <div class="modal-content comment-dialog">
      <div class="modal-header">
        <h3>Update Reimbursement Status</h3>
        <button type="button" class="close-btn" (click)="closeCommentDialog()">&times;</button>
      </div>

      <div class="modal-body">
        <div class="status-info">
          <p>
            <strong>Updating status to:</strong>
            <span class="status-badge" [ngClass]="pendingStatusUpdate?.status">
              {{ pendingStatusUpdate?.status | titlecase }}
            </span>
          </p>
          <p>
            <strong>ID:</strong>
            {{ pendingStatusUpdate!.detailId ? 'Detail ' + pendingStatusUpdate!.detailId : 'Reimbursement ' + pendingStatusUpdate!.id }}
          </p>
        </div>

        <div class="comment-input">
          <label for="statusComment">Comment (Required):</label>
          <textarea
            id="statusComment"
            [(ngModel)]="statusComment"
            placeholder="Please provide a comment for this status update..."
            rows="4"
            class="comment-textarea"
          ></textarea>
          <small class="comment-required">* Comment is required for status updates</small>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="action-btn cancel" (click)="closeCommentDialog()">Cancel</button>
        <button
          type="button"
          class="action-btn confirm"
          (click)="updateReimbursementStatus()"
          [disabled]="!statusComment.trim()"
        >
          Confirm Update
        </button>
      </div>
    </div>
  </div>
</div>