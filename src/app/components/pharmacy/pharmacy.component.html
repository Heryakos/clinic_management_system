<div class="pharmacy-container">
  <h2>Prescription Management</h2>

  <!-- Notification Button -->
  <!-- <div class="notification-btn-container">
    <button type="button" class="notification-btn" (click)="openNotificationDialog()">Send Notification</button>
  </div> -->

  <!-- Search Section -->
  <div class="search-container">
    <form (ngSubmit)="onSearch()" class="search-form">
      <div class="form-group">
        <label for="searchPatientID">Search by Patient ID:</label>
        <input type="text" id="searchPatientID" [(ngModel)]="searchPatientID" name="searchPatientID" class="form-control" placeholder="Enter patient ID">
        <div class="error-message" *ngIf="searchError">{{ searchError }}</div>
      </div>
      <button type="submit" class="search-btn" [disabled]="isSearching">{{ isSearching ? 'Searching...' : 'Search' }}</button>
    </form>
  </div>

  <!-- Medication Stock Selection Section -->
  <div class="medication-stock-container" *ngIf="medicationDetailsWithStock.length > 0">
    <h3>Medication Stock Status</h3>
    <p class="stock-instruction">Check the medications that are currently in stock:</p>
    <div class="medication-stock-list">
<!-- Keep the labels and remove (change) handler -->
<div class="medication-item" *ngFor="let item of medicationDetailsWithStock; let i = index">
  <label>
      <input 
          type="checkbox" 
          [(ngModel)]="item.isInStock" 
          class="stock-checkbox" 
      />
      <span class="medication-name">{{ item.medication }}</span>
      <span class="stock-status" [class.in-stock]="item.isInStock" [class.out-of-stock]="!item.isInStock">
          {{ item.isInStock ? '(In Stock)' : '(Out of Stock)' }}
      </span>
  </label>
</div>
    </div>
  </div>

  <!-- Only show form and table if showFormAndTable is true -->
  <ng-container *ngIf="showFormAndTable">
    <!-- Medicine and Equipment Request Section -->
    <!-- Prescriptions List -->
    <div class="prescriptions-list">
      <h3>{{ isActivePrescriptions ? 'Active Prescriptions' : 'Recent Prescriptions' }}</h3>
      <div class="table-container">
        <table class="prescriptions-table">
          <thead>
            <tr>
              <th>Card Number</th>
              <th>Patient Name</th>
              <th>Prescription Date</th>
              <th>Status</th>
              <th>Prescriber</th>
              <th>Pharmacist</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let prescription of prescriptions" (click)="onPrescriptionRowClick(prescription)">
              <td>{{ prescription.CardNumber }}</td>
              <td>{{ prescription.FullName }}</td>
              <td>{{ prescription.PrescriptionDate | date:'short' }}</td>
              <td>{{ prescription.Status }}</td>
              <td>{{ prescription.PrescriberName }}</td>
              <td>{{ prescription.PharmacistName || 'N/A' }}</td>
              <td>
                <button type="button" class="action-btn view" (click)="viewPrescriptionDetails(prescription.prescriptionID, $event)">View</button>
                <button type="button" class="action-btn dispense" (click)="onDispenseClick(prescription, $event)" *ngIf="prescription.Status === 'Active'" [disabled]="!(getValidPrescriptionId(prescription) || prescription.PrescriptionNumber || prescription.prescriptionNumber || (prescription.CardNumber && (prescription.PrescriptionDate || prescription.prescriptionDate)))">Dispense</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Prescription Details Dialog -->
    <div class="prescription-details-dialog" *ngIf="showPrescriptionDetailsDialog">
      <div class="dialog-backdrop" (click)="closePrescriptionDetailsDialog()"></div>
      <div class="dialog-content">
        <app-prescription-paper [cardNumber]="cardNumber"></app-prescription-paper>
        <button type="button" class="close-btn" (click)="closePrescriptionDetailsDialog()">Close</button>
      </div>
    </div>
  </ng-container>
</div>