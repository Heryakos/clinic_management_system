<div class="pharmacy-container">
  <h2>Prescription Management</h2>

  <!-- Notification Button -->
  <div class="notification-btn-container">
    <button type="button" class="notification-btn" (click)="openNotificationDialog()">Send Notification</button>
  </div>

  <!-- Search Section -->
  <div class="search-container">
    <form (ngSubmit)="onSearch()" class="search-form">
      <div class="form-group">
        <label for="searchPatientID">Search by Patient ID:</label>
        <input type="text" id="searchPatientID" [(ngModel)]="searchPatientID" name="searchPatientID" class="form-control" placeholder="Enter patient ID">
        <div class="error-message" *ngIf="searchError">{{ searchError }}</div>
      </div>
      <button type="submit" class="search-btn" [disabled]="isSearching">{{ isSearching ? 'Searching...' : 'Search' }}</button>
    </form>
  </div>

  <!-- Medication Stock Selection Section -->
  <div class="medication-stock-container" *ngIf="medicationDetailsWithStock.length > 0">
    <h3>Medication Stock Status</h3>
    <p class="stock-instruction">Check the medications that are currently in stock:</p>
    <div class="medication-stock-list">
      <div class="medication-item" *ngFor="let item of medicationDetailsWithStock; let i = index">
        <label>
          <input 
            type="checkbox" 
            [(ngModel)]="item.isInStock" 
            (change)="toggleStockStatus(i)"
            class="stock-checkbox" 
          />
          <span class="medication-name">{{ item.medication }}</span>
          <span class="stock-status" [class.in-stock]="item.isInStock" [class.out-of-stock]="!item.isInStock">
            {{ item.isInStock ? '(In Stock)' : '(Out of Stock)' }}
          </span>
        </label>
      </div>
    </div>
  </div>

  <!-- Only show form and table if showFormAndTable is true -->
  <ng-container *ngIf="showFormAndTable">
    <!-- Medicine and Equipment Request Section -->
    <!-- <div class="inventory-request-section">
      <button type="button" class="toggle-btn" (click)="toggleInventoryRequest()">
        {{ showInventoryRequest ? 'Hide' : 'Manage Medicine & Equipment Requests' }}
      </button>
      <ng-container *ngIf="showInventoryRequest"> -->
        <!-- Inventory Request Form -->
        <!-- <form [formGroup]="inventoryRequestForm" (ngSubmit)="onInventorySubmit()" class="inventory-form">
          <div class="form-row">
            <div class="form-group">
              <label for="requestedFrom">Requested From:</label>
              <select id="requestedFrom" formControlName="requestedFrom" class="form-control">
                <option value="">Select department or supplier</option>
                <option *ngFor="let category of availableCategories" [value]="category.categoryID">
                  {{ category.categoryName }}
                </option>
              </select>
              <div class="error-message" *ngIf="inventoryRequestForm.get('requestedFrom')?.invalid && inventoryRequestForm.get('requestedFrom')?.touched">
                Requested From is required
              </div>
            </div>
            <div class="form-group">
              <label for="reasonForRequest">Reason for Request:</label>
              <app-reason-tree-dropdown
                [reasons]="reasons"
                formControlName="reasonForRequest"
                [placeholder]="'Select reason'"
                [error]="inventoryRequestForm.get('reasonForRequest')?.invalid && inventoryRequestForm.get('reasonForRequest')?.touched ? 'Reason is required' : ''"
                (selectionChange)="onReasonSelection($event)">
              </app-reason-tree-dropdown>
            </div>
            <div class="form-group">
              <label for="requestedBy">Requested By:</label>
              <input type="text" id="requestedBy" formControlName="requestedBy" class="form-control" placeholder="Enter your name" [disabled]="true">
            </div>
          </div>

          <div class="items-section">
            <div class="section-header">
              <h3>Items</h3>
              <button type="button" class="add-btn" (click)="addItem()">+ Add Item</button>
            </div>

            <div class="table-container">
              <table class="items-table">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Item Name</th>
                    <th>Category</th>
                    <th>Unit</th>
                    <th>Quantity</th>
                    <th>Stock Available</th>
                    <th>Job Order #</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody formArrayName="items">
                  <tr *ngFor="let item of itemsFormArray.controls; let i = index" [formGroupName]="i">
                    <td>{{ i + 1 }}</td>
                    <td> -->
                      <!-- <app-medication-tree-dropdown
                        [medications]="categorizedMedications"
                        [placeholder]="'Select medication'"
                        formControlName="medicationID"
                        (selectionChange)="onMedicationSelection($event, i)"
                        [error]="item.get('medicationID')?.invalid && item.get('medicationID')?.touched ? 'Medication is required' : ''">
                      </app-medication-tree-dropdown> -->
                      <!-- <app-item-tree-dropdown
                        [items]="roomSpecificItems"
                        formControlName="itemID"
                        (itemSelected)="onItemSelection($event, i)"
                        [error]="item.get('itemID')?.invalid && item.get('itemID')?.touched ? 'Item is required' : ''">
                      </app-item-tree-dropdown>
                      <div class="error-message" *ngIf="item.get('itemID')?.invalid && item.get('itemID')?.touched">
                        Item is required
                      </div> -->
                    <!-- </td>
                    <td>
                      <input type="text" class="form-control" [value]="getSelectedItemCategory(i)" readonly>
                    </td>
                    <td>
                      <input type="text" formControlName="unit" class="form-control" readonly>
                      <div class="error-message" *ngIf="item.get('unit')?.invalid && item.get('unit')?.touched">
                        Unit is required
                      </div>
                    </td>
                    <td>
                      <input type="number" formControlName="quantity" class="form-control" placeholder="Qty" (input)="checkStockAvailability(i)">
                      <div class="error-message" *ngIf="item.get('quantity')?.invalid && item.get('quantity')?.touched">
                        Valid quantity is required
                      </div>
                    </td>
                    <td>
                      <span [ngClass]="getStockStatusClass(i)">{{ getAvailableStock(i) }}</span>
                    </td>
                    <td>
                      <input type="text" formControlName="jobOrderNo" class="form-control" placeholder="Job order #">
                    </td>
                    <td>
                      <button type="button" class="remove-btn" (click)="removeItem(i)" [disabled]="itemsFormArray.length === 1">
                        Remove
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <button type="submit" class="submit-btn" [disabled]="inventoryRequestForm.invalid || isSubmittingInventory">
              {{ isSubmittingInventory ? 'Submitting...' : 'Submit Request' }}
            </button>
          </div>
        </form> -->

        <!-- Inventory Requests List -->
        <!-- <div class="inventory-requests-list">
          <h3>Recent Medicine & Equipment Requests</h3>
          <div class="table-container">
            <table class="inventory-requests-table">
              <thead>
                <tr>
                  <th>Request Number</th>
                  <th>Requested From</th>
                  <th>Reason</th>
                  <th>Request Date</th>
                  <th>Requested By</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let request of inventoryRequests">
                  <td>{{ request.requestNumber }}</td>
                  <td>{{ request.requestedFrom }}</td>
                  <td>{{ request.reasonForRequest }}</td>
                  <td>{{ request.requestDate | date:'short' }}</td>
                  <td>{{ request.requestedBy }}</td>
                  <td>{{ request.status }}</td>
                  <td>
                    <button class="action-btn view" (click)="viewInventoryRequestDetails(request.id)">View Items</button>
                    <button class="action-btn approve" (click)="updateRequestStatus(request.id, 'approved')" *ngIf="request.status === 'pending'">Approve</button>
                    <button class="action-btn issue" (click)="updateRequestStatus(request.id, 'issued')" *ngIf="request.status === 'approved'">Issue</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div> -->

        <!-- Inventory Request Details Dialog -->
        <!-- <div class="inventory-details-dialog" *ngIf="showInventoryDetailsDialog">
          <div class="dialog-backdrop" (click)="closeInventoryDetailsDialog()"></div>
          <div class="dialog-content">
            <h3>Request Details for #{{ selectedInventoryRequestNumber }}</h3>
            <div *ngIf="selectedInventoryRequestDetails.length > 0; else noInventoryDetails">
              <div class="inventory-detail-card" *ngFor="let item of selectedInventoryRequestDetails">
                <div><strong>Item:</strong> {{ item.itemName || 'N/A' }}</div>
                <div><strong>Unit:</strong> {{ item.unit }}</div>
                <div><strong>Quantity:</strong> {{ item.quantity }}</div>
                <div><strong>Job Order #:</strong> {{ item.jobOrderNo || 'N/A' }}</div>
              </div>
            </div>
            <ng-template #noInventoryDetails>
              <div>No items found for this request.</div>
            </ng-template>
            <button type="button" class="close-btn" (click)="closeInventoryDetailsDialog()">Close</button>
          </div>
        </div>
      </ng-container>
    </div> -->

    <!-- Prescription Form -->
    <!-- <form [formGroup]="prescriptionForm" (ngSubmit)="onSubmit()" class="prescription-form">
      <div class="patient-info">
        <h3>Patient Information</h3>
        <div class="form-row">
          <div class="form-group">
            <label for="patientID">Patient ID:</label>
            <input type="text" id="patientID" formControlName="patientID" class="form-control" placeholder="Enter patient ID" (input)="loadPatientDetails()">
            <div class="error-message" *ngIf="prescriptionForm.get('patientID')?.invalid && prescriptionForm.get('patientID')?.touched">
              Valid Patient ID is required
            </div>
          </div>
          <div class="form-group">
            <label for="patientName">Patient Name:</label>
            <input type="text" id="patientName" formControlName="patientName" class="form-control" readonly>
          </div>
          <div class="form-group">
            <label for="cardNo">Card Number:</label>
            <input type="text" id="cardNo" formControlName="cardNo" class="form-control" readonly>
          </div>
          <div class="form-group">
            <label for="age">Age:</label>
            <input type="text" id="age" formControlName="age" class="form-control" readonly>
          </div>
          <div class="form-group">
            <label for="sex">Sex:</label>
            <input type="text" id="sex" formControlName="sex" class="form-control" readonly>
          </div>
          <div class="form-group">
            <label for="diagnosis">Diagnosis:</label>
            <textarea id="diagnosis" formControlName="diagnosis" class="form-control" placeholder="Enter diagnosis"></textarea>
            <div class="error-message" *ngIf="prescriptionForm.get('diagnosis')?.invalid && prescriptionForm.get('diagnosis')?.touched">
              Diagnosis is required
            </div>
          </div>
        </div>
      </div>

      <div class="medications-section">
        <div class="section-header">
          <h3>Medications</h3>
          <button type="button" class="add-btn" (click)="addMedication()">+ Add Medication</button>
        </div>
        <div formArrayName="medications">
          <div class="medication-item" *ngFor="let medication of medicationsFormArray.controls; let i = index" [formGroupName]="i">
            <div class="medication-header">
              <h4>Medication {{ i + 1 }}</h4>
              <button type="button" class="remove-btn" (click)="removeMedication(i)" [disabled]="medicationsFormArray.length === 1">
                Remove
              </button>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="medicationID-{{i}}">Medication:</label>
                <app-medication-tree-dropdown
                  [medications]="categorizedMedications"
                  [placeholder]="'Select medication'"
                  formControlName="medicationID"
                  [error]="medication.get('medicationID')?.invalid && medication.get('medicationID')?.touched ? 'Medication is required' : ''">
                </app-medication-tree-dropdown>
                <div class="error-message" *ngIf="medication.get('medicationID')?.invalid && medication.get('medicationID')?.touched">
                  Medication is required
                </div>
              </div>
              <div class="form-group">
                <label for="dose-{{i}}">Dose:</label>
                <input type="text" id="dose-{{i}}" formControlName="dose" class="form-control" placeholder="Enter dose">
                <div class="error-message" *ngIf="medication.get('dose')?.invalid && medication.get('dose')?.touched">
                  Dose is required
                </div>
              </div>
              <div class="form-group">
                <label for="frequency-{{i}}">Frequency:</label>
                <input type="text" id="frequency-{{i}}" formControlName="frequency" class="form-control" placeholder="Enter frequency">
                <div class="error-message" *ngIf="medication.get('frequency')?.invalid && medication.get('frequency')?.touched">
                  Frequency is required
                </div>
              </div>
              <div class="form-group">
                <label for="duration-{{i}}">Duration:</label>
                <input type="text" id="duration-{{i}}" formControlName="duration" class="form-control" placeholder="Enter duration">
                <div class="error-message" *ngIf="medication.get('duration')?.invalid && medication.get('duration')?.touched">
                  Duration is required
                </div>
              </div>
              <div class="form-group">
                <label for="quantity-{{i}}">Quantity:</label>
                <input type="number" id="quantity-{{i}}" formControlName="quantity" class="form-control" placeholder="Enter quantity">
                <div class="error-message" *ngIf="medication.get('quantity')?.invalid && medication.get('quantity')?.touched">
                  Valid quantity is required
                </div>
              </div>
              <div class="form-group">
                <label for="unitPrice-{{i}}">Unit Price:</label>
                <input type="number" id="unitPrice-{{i}}" formControlName="unitPrice" class="form-control" placeholder="Enter unit price">
                <div class="error-message" *ngIf="medication.get('unitPrice')?.invalid && medication.get('unitPrice')?.touched">
                  Valid unit price is required
                </div>
              </div>
              <div class="form-group">
                <label for="instructions-{{i}}">Instructions:</label>
                <textarea id="instructions-{{i}}" formControlName="instructions" class="form-control" placeholder="Enter instructions (optional)"></textarea>
              </div>
            </div>
          </div>
        </div>
        <div class="total-price">
          Total Price: {{ calculateTotalPrice() | currency:'ETB':'symbol':'1.2-2' }}
        </div>
      </div>

      <div class="prescriber-info">
        <div class="form-group">
          <label for="pharmacistName">Pharmacist:</label>
          <input type="text" id="pharmacistName" formControlName="pharmacistName" class="form-control" readonly>
        </div>
      </div>

      <button type="submit" class="submit-btn" [disabled]="prescriptionForm.invalid || isSubmitting">
        {{ isSubmitting ? 'Submitting...' : 'Submit Prescription' }}
      </button>
    </form> -->

    <!-- Prescriptions List -->
    <div class="prescriptions-list">
      <h3>{{ isActivePrescriptions ? 'Active Prescriptions' : 'Recent Prescriptions' }}</h3>
      <div class="table-container">
        <table class="prescriptions-table">
          <thead>
            <tr>
              <th>Card Number</th>
              <th>Patient Name</th>
              <th>Prescription Date</th>
              <th>Status</th>
              <th>Prescriber</th>
              <th>Pharmacist</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let prescription of prescriptions">
              <td>{{ prescription.CardNumber }}</td>
              <td>{{ prescription.FullName }}</td>
              <td>{{ prescription.PrescriptionDate | date:'short' }}</td>
              <td>{{ prescription.Status }}</td>
              <td>{{ prescription.PrescriberName }}</td>
              <td>{{ prescription.PharmacistName || 'N/A' }}</td>
              <td>
                <button type="button" class="action-btn view" (click)="viewPrescriptionDetails(prescription.prescriptionID)">View</button>
                <button type="button" class="action-btn dispense" (click)="dispensePrescription(prescription.prescriptionID)" *ngIf="prescription.Status === 'Active'">Dispense</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Prescription Details Dialog -->
    <div class="prescription-details-dialog" *ngIf="showPrescriptionDetailsDialog">
      <div class="dialog-backdrop" (click)="closePrescriptionDetailsDialog()"></div>
      <div class="dialog-content">
        <app-prescription-paper [cardNumber]="cardNumber"></app-prescription-paper>
        <button type="button" class="close-btn" (click)="closePrescriptionDetailsDialog()">Close</button>
      </div>
    </div>
  </ng-container>
</div>